<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GURU DE BANCA ‚Äî Simulador de Banca Chata</title>

  <!-- PDF.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- jsPDF (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --card2:#0f1730;
      --text:#eaf0ff;
      --muted:#a8b3d6;
      --line:rgba(255,255,255,.10);
      --accent:#7c3aed;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 18px 50px rgba(0,0,0,.35);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,.22), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(34,197,94,.12), transparent 55%),
                  radial-gradient(1000px 700px at 40% 90%, rgba(245,158,11,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:9;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.75);
      border-bottom:1px solid var(--line);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .top{
      display:flex; align-items:center; gap:14px; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:42px; height:42px; border-radius:12px;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(34,197,94,1));
      box-shadow: var(--shadow);
    }
    h1{ font-size:16px; margin:0; letter-spacing:.4px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.03);
    }

    main{ padding:18px 0 48px; }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.12);
    }
    .card .hd h2{
      margin:0; font-size:14px; letter-spacing:.3px;
    }
    .card .hd .hint{
      color:var(--muted); font-size:12px; line-height:1.2;
    }
    .card .bd{ padding:14px; }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="file"], select, textarea, input[type="text"]{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
    }
    textarea{ min-height:130px; resize:vertical; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .row{ grid-template-columns:1fr; } }

    .btns{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    button{
      border:0;
      padding:10px 12px;
      border-radius: 14px;
      color: var(--text);
      background: rgba(124,58,237,.9);
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(124,58,237,.18);
      transition: transform .05s ease;
      font-weight:600;
    }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:600;
    }
    button.danger{ background: rgba(239,68,68,.9); box-shadow: 0 10px 24px rgba(239,68,68,.18); }
    button.good{ background: rgba(34,197,94,.9); box-shadow: 0 10px 24px rgba(34,197,94,.18); }

    .kpis{
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){ .kpis{ grid-template-columns:1fr; } }

    .kpi{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding:10px 12px;
    }
    .kpi .v{ font-size:18px; font-weight:800; }
    .kpi .t{ font-size:12px; color:var(--muted); margin-top:4px; }

    .mono{ font-family: var(--mono); font-size:12px; color:var(--muted); }
    .hr{ height:1px; background: var(--line); margin:12px 0; }

    .prof{
      display:flex; gap:12px; align-items:flex-start;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .avatar{
      width:44px; height:44px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(245,158,11,.9), rgba(124,58,237,.9));
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .prof .name{ font-weight:800; font-size:13px; }
    .prof .role{ color:var(--muted); font-size:12px; margin-top:2px; }
    .prof .msg{ margin-top:8px; font-size:13px; line-height:1.35; }

    .tag{
      display:inline-block;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,.03);
      margin-right:6px;
      margin-top:6px;
    }

    .feedback{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding:12px;
      margin-top:12px;
    }
    .feedback h3{ margin:0 0 6px; font-size:13px; }
    .list{ margin:8px 0 0; padding-left:18px; color:var(--text); }
    .list li{ margin:6px 0; color:var(--text); }
    .muted{ color:var(--muted); }

    .small{ font-size:12px; color:var(--muted); }
    .hide{ display:none !important; }

    .scorebar{
      height:10px; border-radius:999px; background: rgba(255,255,255,.08);
      overflow:hidden; border:1px solid var(--line);
    }
    .scorefill{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(239,68,68,.9), rgba(245,158,11,.9), rgba(34,197,94,.9));
    }

    .toast{
      position:fixed; right:16px; bottom:16px;
      background: rgba(17,26,46,.96);
      border:1px solid var(--line);
      color: var(--text);
      padding:12px 12px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      max-width: 360px;
      z-index:999;
    }
    .toast .t{ font-weight:800; font-size:13px; }
    .toast .b{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35; }
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>GURU DE BANCA</h1>
        <div class="sub">Simulador de banca chata (TCC ‚Ä¢ Mestrado ‚Ä¢ Doutorado) + relat√≥rio final em PDF</div>
      </div>
    </div>
    <div class="pill">Modo: <span id="modePill">‚Äî</span></div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- LEFT -->
    <section class="card">
      <div class="hd">
        <div>
          <h2>1) Upload + Configura√ß√£o</h2>
          <div class="hint">Carregue seu PDF e escolha o n√≠vel/√°rea. Eu vou te apertar com perguntas de banca (daquelas que d√£o frio na espinha).</div>
        </div>
      </div>
      <div class="bd">

        <label>Seu nome (opcional ‚Äî vai no relat√≥rio)</label>
        <input id="studentName" type="text" placeholder="Ex: Ana Silva" />

        <div style="height:10px"></div>

        <label>Upload do PDF (TCC / Disserta√ß√£o / Tese)</label>
        <input id="pdfInput" type="file" accept="application/pdf" />

        <div style="height:10px"></div>

        <div class="row">
          <div>
            <label>N√≠vel</label>
            <select id="level">
              <option value="tcc">TCC</option>
              <option value="msc">Mestrado</option>
              <option value="phd">Doutorado</option>
            </select>
          </div>
          <div>
            <label>√Årea</label>
            <select id="area">
              <option value="bio">Biol√≥gicas/Ambientais</option>
              <option value="exa">Exatas/Tecnologia</option>
              <option value="hum">Humanas/Sociais</option>
              <option value="int">Interdisciplinar</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <label>N√≠vel da banca</label>
        <select id="severity">
          <option value="calm">Tranquila</option>
          <option value="tech">T√©cnica</option>
          <option value="hard" selected>Chata (recomendada)</option>
        </select>

        <div class="btns">
          <button class="good" id="btnAnalyze">Analisar PDF e come√ßar</button>
          <button class="secondary" id="btnLoadDemo">Usar modo DEMO (sem PDF)</button>
          <button class="secondary" id="btnResume">Retomar sess√£o salva</button>
          <button class="danger" id="btnReset">Resetar tudo</button>
        </div>

        <div class="hr"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="v" id="kpiPages">‚Äî</div>
            <div class="t">P√°ginas lidas</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiWords">‚Äî</div>
            <div class="t">Palavras extra√≠das</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiConfidence">‚Äî</div>
            <div class="t">Confian√ßa do diagn√≥stico</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="mono" id="docDigest">Aguardando PDF‚Ä¶</div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="hd">
        <div>
          <h2>2) Diagn√≥stico + Simula√ß√£o</h2>
          <div class="hint">Pergunta ‚Üí sua resposta ‚Üí repregunta chata ‚Üí feedback. No final: nota estimada e relat√≥rio em PDF.</div>
        </div>
      </div>
      <div class="bd">

        <div class="prof">
          <div class="avatar"></div>
          <div>
            <div class="name">Professor(a) da Banca (modo chato)</div>
            <div class="role" id="profRole">‚Äî</div>
            <div class="msg" id="questionBox">Fa√ßa upload e clique em <b>Analisar PDF</b>. Se quiser testar, use o modo DEMO.</div>
            <div id="questionTags"></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <label>Sua resposta (objetiva, sem enrolar)</label>
        <textarea id="answer" placeholder="Responda como se estivesse na banca. Pense em: objetivo ‚Üí evid√™ncia ‚Üí limite ‚Üí implica√ß√£o."></textarea>

        <div class="btns">
          <button id="btnAnswer">Responder</button>
          <button class="secondary" id="btnHint">Pedir dica</button>
          <button class="secondary" id="btnIDK">N√£o sei responder</button>
        </div>

        <div class="feedback hide" id="feedbackBox">
          <h3>Feedback do professor chato</h3>
          <div class="small" id="feedbackSummary">‚Äî</div>
          <ul class="list" id="feedbackList"></ul>
          <div class="hr"></div>
          <div class="small muted">E agora eu vou te apertar de novo (repregunta):</div>
          <div style="margin-top:8px; font-weight:800" id="followupQ">‚Äî</div>
          <div class="btns">
            <button class="good" id="btnNext">Pr√≥xima pergunta</button>
            <button class="secondary" id="btnFinish">Finalizar e gerar relat√≥rio</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="small muted">Progresso da simula√ß√£o</div>
        <div class="scorebar" style="margin-top:8px;">
          <div class="scorefill" id="progressFill"></div>
        </div>
        <div class="small" style="margin-top:8px;">
          Perguntas respondidas: <b id="qDone">0</b> / <b id="qTotal">0</b> ‚Ä¢ Nota parcial estimada: <b id="liveGrade">‚Äî</b>
        </div>

      </div>
    </aside>

  </div>
</main>

<div id="toast" class="toast hide">
  <div class="t" id="toastT">‚Äî</div>
  <div class="b" id="toastB">‚Äî</div>
</div>

<script>
/* =========================
   UTIL
========================= */
const $ = (id) => document.getElementById(id);

function toast(title, body, ms=2600){
  $("toastT").textContent = title;
  $("toastB").textContent = body;
  $("toast").classList.remove("hide");
  setTimeout(()=> $("toast").classList.add("hide"), ms);
}

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function wordsCount(s){
  return (s||"").trim().split(/\s+/).filter(Boolean).length;
}

function pct(n){ return Math.round(n*100) + "%"; }

function nowISO(){
  const d = new Date();
  return d.toISOString().slice(0,19).replace("T"," ");
}

/* =========================
   PDF EXTRACTION (PDF.js)
========================= */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

async function extractPdfText(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

  let full = "";
  for(let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const strings = content.items.map(it => it.str);
    full += "\n\n" + strings.join(" ");
  }
  return { pages: pdf.numPages, text: full };
}

/* =========================
   HEURISTIC PARSER
========================= */
function normalize(s){
  return (s||"")
    .replace(/\s+/g," ")
    .replace(/[‚Äú‚Äù]/g,'"')
    .replace(/[‚Äò‚Äô]/g,"'")
    .trim();
}

function detectSections(text){
  const t = text.toLowerCase();
  const has = (re) => re.test(t);

  const sections = {
    intro: has(/\b(introdu(√ß|c)√£o|introducao)\b/),
    obj: has(/\b(objetivo(s)?|objetivo geral|objetivos espec√≠ficos|objetivos especificos)\b/),
    prob: has(/\b(problema de pesquisa|quest(√£|a)o de pesquisa|pergunta de pesquisa)\b/),
    hypo: has(/\b(hip(√≥|o)tese(s)?|hipotese(s)?)\b/),
    meth: has(/\b(metodologia|materiais e m(√©|e)todos|m(√©|e)todo(s)?|procedimentos)\b/),
    res: has(/\b(resultados)\b/),
    disc: has(/\b(discuss(√£|a)o)\b/),
    conc: has(/\b(conclus(√£|a)o|considera(√ß|c)(√µ|o)es finais)\b/),
    lim: has(/\b(limita(√ß|c)(√µ|o)es|limita√ß√µes)\b/),
    ref: has(/\b(refer(√™|e)ncias|bibliografia)\b/)
  };

  // tentativa de t√≠tulo: primeiras linhas "fortes"
  const firstChunk = normalize(text.slice(0, 1200));
  const lines = firstChunk.split(/[\n\r]+/).map(l => l.trim()).filter(Boolean);
  let title = "";
  for(const ln of lines.slice(0, 12)){
    if(ln.length >= 12 && ln.length <= 180){
      // heur√≠stica: linha com poucas pontua√ß√µes e mais "maiusculas"
      const letters = ln.replace(/[^A-Za-z√Ä-√ø]/g,"");
      const upper = (ln.match(/[A-Z√Ä-√ù]/g)||[]).length;
      const ratio = letters.length ? upper/letters.length : 0;
      if(ratio > 0.18 && ln.split(" ").length >= 3){
        title = ln;
        break;
      }
    }
  }

  // objetivo/problema (extrair trecho com regex simples)
  const pick = (re) => {
    const m = text.match(re);
    if(!m) return "";
    return normalize(m[1] || m[0]).slice(0, 420);
  };

  const objective = pick(/objetivo(?: geral)?[:\-‚Äì]\s*([\s\S]{30,500}?)(?:\n|\r|\. {1,2}|objetivos espec√≠ficos|objetivos especificos|metodologia|materiais e m√©todos)/i);
  const problem = pick(/(problema de pesquisa|quest(√£|a)o de pesquisa|pergunta de pesquisa)[:\-‚Äì]\s*([\s\S]{30,500}?)(?:\n|\r|hip(√≥|o)tese|objetivo|metodologia)/i);

  // confian√ßa
  const hitCount = Object.values(sections).filter(Boolean).length;
  const confidence =
    hitCount >= 6 ? "alta" :
    hitCount >= 3 ? "m√©dia" : "baixa";

  return { title, sections, objective, problem, confidence };
}

/* =========================
   QUESTION ENGINE
========================= */
function buildQuestionBank(ctx){
  const { level, area, severity, meta } = ctx;

  // tags: ["metodo","teoria","resultado","limite","originalidade","aplicacao","dados","estatistica","etica"]
  const base = [
    { id:"core_01", tags:["core","clareza"], text:"Em uma frase: qual √© o seu problema de pesquisa? E n√£o me d√™ contexto: me d√™ o problema.", follow:"Voc√™ consegue mostrar onde isso aparece no texto? Em que p√°gina/trecho?"},
    { id:"core_02", tags:["core","relevancia"], text:"Por que isso importa? Me d√™ 1 raz√£o cient√≠fica e 1 raz√£o pr√°tica (social, pol√≠tica p√∫blica, gest√£o, tecnologia).", follow:"Se eu discordar, qual evid√™ncia voc√™ tem para sustentar essa relev√¢ncia?"},
    { id:"core_03", tags:["core","objetivos"], text:"Quais s√£o seus objetivos (geral e espec√≠ficos) e como cada espec√≠fico vira uma an√°lise/etapa concreta?", follow:"Qual objetivo ficou mais fraco e por qu√™?"},
    { id:"core_04", tags:["core","contribuicao"], text:"Qual √© sua contribui√ß√£o original? O que muda no mundo acad√™mico depois do seu trabalho?", follow:"Se eu disser que isso j√° existe na literatura, como voc√™ me convence do contr√°rio?"},
    { id:"core_05", tags:["core","limites"], text:"Qual √© a limita√ß√£o mais grave do seu estudo? A mais perigosa mesmo.", follow:"Se essa limita√ß√£o for real, o que cai primeiro: m√©todo, resultado ou conclus√£o?"}
  ];

  const meth = [
    { id:"m_01", tags:["metodo","coerencia"], text:"Por que voc√™ escolheu esse m√©todo/delineamento e n√£o outro mais simples ou mais robusto?", follow:"Qual alternativa voc√™ considerou e por que descartou?"},
    { id:"m_02", tags:["metodo","amostra"], text:"Sua amostra (ou corpus/dados) √© suficiente e representativa? Defina 'suficiente' com crit√©rio.", follow:"Se eu reduzir sua amostra pela metade, suas conclus√µes ainda ficam em p√©?"},
    { id:"m_03", tags:["metodo","vi√©s"], text:"Quais s√£o os principais vieses do seu desenho e o que voc√™ fez para mitig√°-los?", follow:"Qual vi√©s voc√™ n√£o conseguiu controlar e como isso pode distorcer seu resultado?"},
    { id:"m_04", tags:["metodo","replicabilidade"], text:"Se eu quiser reproduzir seu estudo amanh√£, o que eu preciso saber que N√ÉO est√° expl√≠cito no seu texto?", follow:"Qual detalhe, se faltar, torna seu estudo irreprodut√≠vel?"},
  ];

  const stats = [
    { id:"s_01", tags:["estatistica","dados"], text:"Voc√™ est√° inferindo ou s√≥ descrevendo? Onde entra a incerteza: intervalo, erro, robustez, sensibilidade?", follow:"Se eu pedir um teste de robustez, qual voc√™ faria primeiro?"},
    { id:"s_02", tags:["estatistica","causalidade"], text:"Voc√™ est√° falando de correla√ß√£o ou causalidade? Me prove que voc√™ sabe a diferen√ßa no seu caso.", follow:"Qual vari√°vel de confus√£o pode estar dirigindo seu efeito?"},
    { id:"s_03", tags:["estatistica","modelo"], text:"Qual suposi√ß√£o do seu modelo/an√°lise √© a mais fr√°gil? E o que acontece se ela falhar?", follow:"Como voc√™ detectaria que ela falhou, na pr√°tica?"}
  ];

  const theory = [
    { id:"t_01", tags:["teoria","fundamentacao"], text:"Qual √© o pilar te√≥rico do seu trabalho? Se eu tirar isso, seu trabalho ainda existe?", follow:"Qual autor/linha voc√™ discorda parcialmente? E por qu√™?"},
    { id:"t_02", tags:["teoria","conceitos"], text:"Defina operacionalmente os seus 2 conceitos centrais. Como voc√™ mede/observa isso no mundo real?", follow:"Se eu mudar sua defini√ß√£o, seu resultado muda? Em que dire√ß√£o?"},
    { id:"t_03", tags:["teoria","lacuna"], text:"Qual lacuna EXATA na literatura voc√™ est√° preenchendo? Lacuna real, n√£o 'faltam estudos'.", follow:"Quem √© o principal trabalho que voc√™ est√° estendendo ou contrariando?"}
  ];

  const results = [
    { id:"r_01", tags:["resultado","evidencia"], text:"Qual √© o seu resultado mais forte? Me diga o achado e a evid√™ncia que o sustenta.", follow:"Qual explica√ß√£o alternativa existe para esse achado?"},
    { id:"r_02", tags:["resultado","discussao"], text:"Onde voc√™ pode estar super-interpretando seus dados? Aponte uma frase do seu texto que voc√™ mesmo reescreveria.", follow:"Qual seria uma vers√£o mais cautelosa dessa frase?"},
    { id:"r_03", tags:["resultado","generalizacao"], text:"At√© onde voc√™ pode generalizar? Onde voc√™ N√ÉO pode generalizar de jeito nenhum?", follow:"Se algu√©m aplicar sua conclus√£o fora do seu contexto, qual erro ela cometeria?"}
  ];

  const ethics = [
    { id:"e_01", tags:["etica","dados"], text:"Existe risco √©tico, vi√©s social, privacidade, impacto em grupos? Como voc√™ tratou isso?", follow:"Se eu for duro: onde voc√™ pode ter sido ing√™nuo(a) eticamente?"},
  ];

  const practical = [
    { id:"p_01", tags:["aplicacao","impacto"], text:"Se eu te der 2 minutos com um gestor/pol√≠tico/empresa: qual recomenda√ß√£o pr√°tica voc√™ faz, com base no seu trabalho?", follow:"O que pode dar errado se aplicarem sua recomenda√ß√£o sem cautela?"},
    { id:"p_02", tags:["aplicacao","futuro"], text:"Qual √© a agenda de pesquisa/continuidade mais √≥bvia ap√≥s sua defesa? Seja espec√≠fico.", follow:"Qual continua√ß√£o seria mais 'barata' e qual seria a mais 'transformadora'?"}
  ];

  // Ajustes por √°rea (pequenos, mas √∫teis)
  if(area === "hum"){
    practical.push({ id:"h_01", tags:["metodo","hum"], text:"Como voc√™ garante validade/credibilidade (triangula√ß√£o, satura√ß√£o, confiabilidade, rigor interpretativo)?", follow:"Se eu disser que √© 's√≥ opini√£o', como voc√™ responde?"});
  }
  if(area === "exa"){
    stats.push({ id:"x_01", tags:["metodo","exa"], text:"Qual parte do seu pipeline √© mais vulner√°vel a erro (pr√©-processamento, par√¢metro, valida√ß√£o, implementa√ß√£o)?", follow:"Como voc√™ testou/certificou que n√£o √© bug?"});
  }
  if(area === "bio"){
    meth.push({ id:"b_01", tags:["metodo","bio"], text:"Que controles (experimentais/observacionais) garantem que o efeito n√£o √© artefato do ambiente/coleta?", follow:"Qual vari√°vel ambiental n√£o controlada pode inverter sua interpreta√ß√£o?"});
  }

  // Sele√ß√£o guiada pela presen√ßa de se√ß√µes
  const bank = [...base];

  const s = meta.sections || {};
  const includeMeth = s.meth || severity !== "calm";
  const includeTheory = s.intro || s.ref || severity !== "calm";
  const includeResults = s.res || s.disc || s.conc || severity !== "calm";

  if(includeMeth) bank.push(...meth, ...stats);
  if(includeTheory) bank.push(...theory);
  if(includeResults) bank.push(...results, ...practical);
  if(severity !== "calm") bank.push(...ethics);

  // Em ‚Äúchata‚Äù, aumenta o n√∫cleo e adiciona ‚Äúpegadinhas‚Äù
  if(severity === "hard"){
    bank.push(
      { id:"h_peg_01", tags:["core","pegadinha"], text:"Se eu disser que seu objetivo N√ÉO est√° alinhado ao m√©todo, onde exatamente voc√™ prova que est√°?", follow:"Qual parte do m√©todo voc√™ mudaria para alinhar melhor?"},
      { id:"h_peg_02", tags:["metodo","pegadinha"], text:"Qual √© a cr√≠tica mais destrutiva que algu√©m poderia fazer ao seu trabalho? Fa√ßa por mim.", follow:"Agora se defenda ‚Äî sem ser defensivo(a)."},
      { id:"h_peg_03", tags:["resultado","pegadinha"], text:"Qual resultado seu pode ser simplesmente ru√≠do? Qual parte pode ser efeito de confus√£o?", follow:"Qual an√°lise adicional reduziria essa d√∫vida?"}
    );
  }

  // Em ‚Äútranquila‚Äù, limita a quantidade e suaviza
  let final = bank;

  // ordem: core primeiro, depois m√©todo/teoria/resultados
  final.sort((a,b)=>{
    const A = a.tags.includes("core") ? 0 : 1;
    const B = b.tags.includes("core") ? 0 : 1;
    return A - B;
  });

  // tamanho por n√≠vel
  const n =
    level === "tcc" ? 18 :
    level === "msc" ? 24 : 30;

  // embaralhar mantendo n√∫cleo no topo
  const core = final.filter(q => q.tags.includes("core"));
  const rest = final.filter(q => !q.tags.includes("core"));
  shuffle(rest);
  final = [...core, ...rest].slice(0, n);

  // garante followup
  final = final.map(q => ({...q, follow: q.follow || "Ok. Mas por que eu deveria acreditar nisso?"}));

  return final;
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
}

/* =========================
   SCORING (Heur√≠stico)
========================= */
function evaluateAnswer(q, answer, ctx){
  const a = (answer||"").trim();
  const wc = wordsCount(a);

  // Heur√≠sticas simples (mas √∫teis)
  const tooShort = wc < 35;
  const tooLong  = wc > 220;

  const hasStructure = /porque|portanto|assim|logo|evid(√™|e)ncia|dados|resultado|m(√©|e)todo|limita(√ß|c)(√£|a)o|no meu estudo/i.test(a);
  const hasNumbers = /\d/.test(a);
  const hedging = /(acho|talvez|meio que|tipo|sei l√°|n√£o lembro|creio|imagino)/i.test(a);

  // penalidades/bonus por severidade
  const sev = ctx.severity;
  let clarity = 6.5, method = 6.5, theory = 6.5, result = 6.5, limits = 6.5, confidence = 6.5;

  // Clareza
  if(tooShort) clarity -= 2.2;
  if(tooLong) clarity -= 1.2;
  if(hasStructure) clarity += 1.2;
  if(hedging) clarity -= 1.2;

  // M√©todo
  if(q.tags.includes("metodo") || q.tags.includes("estatistica")){
    if(hasStructure) method += 1.0;
    if(hasNumbers) method += 0.8;
    if(tooShort) method -= 1.8;
    if(hedging) method -= 1.0;
  }

  // Teoria
  if(q.tags.includes("teoria")){
    if(/autor|literatura|teoria|conceito|refer(√™|e)ncia/i.test(a)) theory += 1.1;
    if(tooShort) theory -= 1.6;
    if(hedging) theory -= 0.8;
  }

  // Resultado/Discuss√£o
  if(q.tags.includes("resultado") || q.tags.includes("aplicacao")){
    if(/encontrei|observ(ei|amos)|mostrou|indicou|aumentou|reduziu|associ/i.test(a)) result += 1.0;
    if(/alternativa|confus|incertez|interval|robust|sensibil/i.test(a)) result += 1.0;
    if(tooShort) result -= 1.8;
  }

  // Limita√ß√µes
  if(q.tags.includes("limite") || /limita/i.test(q.text)){
    if(/limita|vi(e|√©)s|restri(√ß|c)(√£|a)o|amostra|generaliza/i.test(a)) limits += 1.2;
    if(/mas|por(√©|e)m|contudo/i.test(a)) limits += 0.5;
    if(tooShort) limits -= 1.5;
  }

  // Seguran√ßa
  confidence += (hasStructure ? 0.9 : -0.6);
  confidence += (hedging ? -1.6 : 0.3);
  confidence += (tooShort ? -1.0 : 0.4);

  // Bancas mais chatas punem mais enrola√ß√£o e ‚Äún√£o sei‚Äù
  if(sev === "hard"){
    if(tooLong) confidence -= 0.8;
    if(hedging) confidence -= 0.8;
  }

  // Clamp 0-10
  const dims = {
    clarity: clamp(clarity,0,10),
    theory: clamp(theory,0,10),
    method: clamp(method,0,10),
    result: clamp(result,0,10),
    limits: clamp(limits,0,10),
    confidence: clamp(confidence,0,10),
  };

  // coment√°rios ‚Äúchatos‚Äù
  const hits = [];
  if(tooShort) hits.push("Muito curto. Em banca, isso soa como inseguran√ßa ou falta de dom√≠nio.");
  if(tooLong) hits.push("Longo demais. Voc√™ est√° se defendendo em vez de responder.");
  if(hedging) hits.push("Cuidado com 'acho', 'talvez', 'tipo'. Banca chata marca isso como fragilidade.");
  if(!hasStructure) hits.push("Faltou estrutura: objetivo ‚Üí evid√™ncia ‚Üí limite ‚Üí implica√ß√£o.");

  // sugest√µes ‚Äúfrases prontas‚Äù
  const tips = [];
  if(!hasStructure) tips.push("Use a estrutura: **(1)** ponto central, **(2)** evid√™ncia/dado, **(3)** limita√ß√£o, **(4)** implica√ß√£o.");
  if(q.tags.includes("estatistica") && !hasNumbers) tips.push("Quando der, cite pelo menos **um n√∫mero** (n, per√≠odo, efeito, erro, intervalo).");
  if(q.tags.includes("limite") && !/limita|vi(e|√©)s|restri/i.test(a)) tips.push("Assuma uma limita√ß√£o real e diga como voc√™ mitigou ou como isso entra em trabalhos futuros.");

  return { dims, hits, tips, wc };
}

/* =========================
   REPORT / GRADE
========================= */
function computeGrade(session){
  const { level } = session.ctx;

  // m√©dias
  const avg = (k) => {
    const arr = session.answers.map(x => x.score?.dims?.[k]).filter(v => typeof v === "number");
    if(!arr.length) return 0;
    return arr.reduce((a,b)=>a+b,0)/arr.length;
  };

  const clarity = avg("clarity");
  const theory  = avg("theory");
  const method  = avg("method");
  const result  = avg("result");
  const limits  = avg("limits");
  const conf    = avg("confidence");

  // pesos por n√≠vel
  let w;
  if(level === "tcc"){
    w = { clarity:.20, theory:.14, method:.22, result:.16, limits:.14, confidence:.14 };
  } else if(level === "msc"){
    w = { clarity:.16, theory:.18, method:.20, result:.18, limits:.14, confidence:.14 };
  } else { // phd
    w = { clarity:.14, theory:.20, method:.22, result:.18, limits:.12, confidence:.14 };
  }

  const final = clarity*w.clarity + theory*w.theory + method*w.method + result*w.result + limits*w.limits + conf*w.confidence;

  return {
    dims: { clarity, theory, method, result, limits, confidence: conf },
    final: clamp(final,0,10)
  };
}

function topRisks(session){
  // conta recorr√™ncias de problemas
  const issues = [];
  for(const a of session.answers){
    for(const h of (a.score?.hits||[])){
      issues.push(h);
    }
  }
  const freq = {};
  issues.forEach(x => freq[x] = (freq[x]||0)+1);

  const ranked = Object.entries(freq).sort((a,b)=>b[1]-a[1]);
  return ranked.slice(0,5).map(([txt,n])=>({txt,n}));
}

function likelyQuestions(session){
  // retorna 10 perguntas "mais prov√°veis" = core + tags cr√≠ticas + as que o aluno foi pior
  const answers = session.answers.slice();
  answers.sort((a,b)=>{
    const sa = avgScore(a.score), sb = avgScore(b.score);
    return sa - sb; // pior primeiro
  });
  const worst = answers.slice(0,6).map(x => x.q);

  const core = session.questions.filter(q => q.tags.includes("core")).slice(0,6);
  const set = new Map();
  [...core, ...worst].forEach(q => set.set(q.id, q));
  return Array.from(set.values()).slice(0,10);
}

function avgScore(score){
  if(!score?.dims) return 0;
  const v = Object.values(score.dims);
  return v.reduce((a,b)=>a+b,0)/v.length;
}

/* =========================
   SESSION STATE
========================= */
const SESSION_KEY = "guru_de_banca_session_v1";

let session = null;

function makeEmptySession(ctx, meta){
  return {
    version: 1,
    createdAt: nowISO(),
    ctx,
    meta,
    questions: [],
    qi: 0,
    answers: [],
  };
}

function saveSession(){
  if(!session) return;
  localStorage.setItem(SESSION_KEY, JSON.stringify(session));
}

function loadSession(){
  const raw = localStorage.getItem(SESSION_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); } catch(e){ return null; }
}

function resetSession(){
  localStorage.removeItem(SESSION_KEY);
  session = null;
  renderIdle();
  toast("Resetado", "Sess√£o apagada. Agora fa√ßa upload do PDF novamente.");
}

/* =========================
   RENDER
========================= */
function setModePill(){
  if(!session){ $("modePill").textContent = "‚Äî"; return; }
  const lvl = {tcc:"TCC",msc:"Mestrado",phd:"Doutorado"}[session.ctx.level];
  const sev = {calm:"Tranquila",tech:"T√©cnica",hard:"Chata"}[session.ctx.severity];
  $("modePill").textContent = `${lvl} ‚Ä¢ ${sev}`;
}

function renderIdle(){
  $("kpiPages").textContent = "‚Äî";
  $("kpiWords").textContent = "‚Äî";
  $("kpiConfidence").textContent = "‚Äî";
  $("docDigest").textContent = "Aguardando PDF‚Ä¶";
  $("profRole").textContent = "‚Äî";
  $("questionBox").innerHTML = 'Fa√ßa upload e clique em <b>Analisar PDF</b>. Se quiser testar, use o modo DEMO.';
  $("questionTags").innerHTML = "";
  $("feedbackBox").classList.add("hide");
  $("answer").value = "";
  $("qDone").textContent = "0";
  $("qTotal").textContent = "0";
  $("liveGrade").textContent = "‚Äî";
  $("progressFill").style.width = "0%";
  setModePill();
}

function renderMeta(meta, pages, words){
  $("kpiPages").textContent = pages ?? "‚Äî";
  $("kpiWords").textContent = words ?? "‚Äî";
  $("kpiConfidence").textContent = meta?.confidence ? meta.confidence.toUpperCase() : "‚Äî";

  const s = meta.sections || {};
  const title = meta.title ? `T√≠tulo (aprox): "${meta.title}"` : "T√≠tulo: (n√£o detectado com confian√ßa)";
  const obj = meta.objective ? `Objetivo (trecho): ${meta.objective}` : "Objetivo: (n√£o detectado)";
  const prob = meta.problem ? `Problema (trecho): ${meta.problem}` : "Problema: (n√£o detectado)";

  const flags = Object.entries(s).filter(([k,v])=>v).map(([k])=>k.toUpperCase());
  $("docDigest").textContent =
    `${title}\n${obj}\n${prob}\nSe√ß√µes detectadas: ${flags.length ? flags.join(", ") : "poucas/nenhuma"}\nDica: se a confian√ßa estiver baixa, seu PDF pode estar sem cabe√ßalhos claros.`;
}

function renderQuestion(){
  setModePill();
  const q = session.questions[session.qi];
  if(!q){
    $("questionBox").innerHTML = "Sem mais perguntas. Gere o relat√≥rio final.";
    $("questionTags").innerHTML = "";
    $("qTotal").textContent = String(session.questions.length);
    return;
  }

  // ‚Äúpersonas‚Äù m√≠nimas por tag
  let role = "Eu j√° participei de mais de 100 bancas. Responda com precis√£o.";
  if(q.tags.includes("metodo")) role = "Metodologia: vou ca√ßar incoer√™ncia e vi√©s.";
  if(q.tags.includes("teoria")) role = "Teoria: vou testar sua fundamenta√ß√£o e conceito.";
  if(q.tags.includes("resultado")) role = "Resultados: vou apertar robustez e interpreta√ß√£o.";
  if(q.tags.includes("estatistica")) role = "Estat√≠stica: vou perguntar suposi√ß√µes e incerteza.";
  if(q.tags.includes("core")) role = "B√°sico: se voc√™ erra isso, a banca te desmonta.";

  $("profRole").textContent = role;
  $("questionBox").textContent = q.text;

  $("questionTags").innerHTML =
    q.tags.map(t => `<span class="tag">${t}</span>`).join("");

  $("answer").value = "";
  $("feedbackBox").classList.add("hide");

  const done = session.answers.length;
  const total = session.questions.length;
  $("qDone").textContent = String(done);
  $("qTotal").textContent = String(total);

  const g = computeGrade(session).final;
  $("liveGrade").textContent = g ? g.toFixed(1) : "‚Äî";

  $("progressFill").style.width = total ? pct(done/total) : "0%";
}

function renderFeedback(score, followup){
  $("feedbackBox").classList.remove("hide");

  const dims = score.dims;
  const avg = avgScore(score);

  const mood =
    avg >= 8.2 ? {c:"good", t:"Boa. N√£o me decepcionou (ainda)."} :
    avg >= 6.6 ? {c:"warn", t:"D√° pra passar, mas tem vulnerabilidade."} :
                 {c:"bad",  t:"Perigoso. Em banca chata, isso sangra nota."};

  $("feedbackSummary").innerHTML =
    `<b style="color:var(--${mood.c})">${mood.t}</b> ‚Ä¢ ` +
    `Clareza ${dims.clarity.toFixed(1)} | Teoria ${dims.theory.toFixed(1)} | M√©todo ${dims.method.toFixed(1)} | Resultados ${dims.result.toFixed(1)} | Limites ${dims.limits.toFixed(1)} | Seguran√ßa ${dims.confidence.toFixed(1)} ` +
    `<span class="muted">‚Ä¢ ${score.wc} palavras</span>`;

  const li = [];
  (score.hits||[]).forEach(x => li.push(`‚ùå ${x}`));
  (score.tips||[]).forEach(x => li.push(`üîß ${x}`));
  if(!li.length) li.push("‚úÖ Resposta ok. Agora sustente isso com consist√™ncia e evid√™ncia.");

  $("feedbackList").innerHTML = li.map(x => `<li>${x}</li>`).join("");
  $("followupQ").textContent = followup;
}

/* =========================
   REPORT PDF
========================= */
async function generatePdfReport(session){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  const name = (session.ctx.studentName || "Aluno(a)").trim();
  const levelLabel = {tcc:"TCC",msc:"Mestrado",phd:"Doutorado"}[session.ctx.level];
  const sevLabel = {calm:"Tranquila",tech:"T√©cnica",hard:"Chata"}[session.ctx.severity];
  const areaLabel = {bio:"Biol√≥gicas/Ambientais",exa:"Exatas/Tecnologia",hum:"Humanas/Sociais",int:"Interdisciplinar"}[session.ctx.area];

  const g = computeGrade(session);
  const risks = topRisks(session);
  const qLikely = likelyQuestions(session);

  const meta = session.meta || {};
  const title = meta.title || "(t√≠tulo n√£o detectado)";
  const conf = (meta.confidence || "baixa").toUpperCase();

  let y = 52;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("GURU DE BANCA ‚Äî Relat√≥rio de Prepara√ß√£o", 40, y); y += 18;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  doc.text(`Gerado em: ${nowISO()}`, 40, y); y += 14;

  doc.setFont("helvetica", "bold");
  doc.text(`Aluno(a): `, 40, y);
  doc.setFont("helvetica", "normal");
  doc.text(name, 98, y); y += 14;

  doc.setFont("helvetica", "bold");
  doc.text(`N√≠vel: `, 40, y);
  doc.setFont("helvetica", "normal");
  doc.text(`${levelLabel} ‚Ä¢ √Årea: ${areaLabel} ‚Ä¢ Banca: ${sevLabel}`, 84, y); y += 16;

  doc.setFont("helvetica", "bold");
  doc.text("Trabalho (diagn√≥stico do PDF)", 40, y); y += 14;
  doc.setFont("helvetica", "normal");
  doc.text(`T√≠tulo: ${title}`, 40, y, { maxWidth: 520 }); y += 14;
  doc.text(`Confian√ßa do diagn√≥stico: ${conf}`, 40, y); y += 14;

  if(meta.objective){
    doc.text(`Objetivo (trecho): ${meta.objective}`, 40, y, { maxWidth: 520 }); y += 28;
  } else {
    doc.text("Objetivo: n√£o detectado automaticamente. Sugest√£o: deixe claro no texto com cabe√ßalho 'Objetivo'.", 40, y, { maxWidth: 520 }); y += 28;
  }

  doc.setFont("helvetica", "bold");
  doc.text("Nota estimada da banca", 40, y); y += 14;

  doc.setFont("helvetica", "normal");
  doc.text(`Nota final estimada: ${g.final.toFixed(1)} / 10`, 40, y); y += 14;
  doc.text(`Clareza: ${g.dims.clarity.toFixed(1)} | Teoria: ${g.dims.theory.toFixed(1)} | M√©todo: ${g.dims.method.toFixed(1)}`, 40, y); y += 14;
  doc.text(`Resultados: ${g.dims.result.toFixed(1)} | Limita√ß√µes: ${g.dims.limits.toFixed(1)} | Seguran√ßa: ${g.dims.confidence.toFixed(1)}`, 40, y); y += 18;

  doc.setFont("helvetica", "bold");
  doc.text("Riscos cr√≠ticos (o que pode derrubar sua nota)", 40, y); y += 14;
  doc.setFont("helvetica", "normal");
  if(!risks.length){
    doc.text("Sem riscos frequentes detectados (poucas respostas ou respostas consistentes).", 40, y); y += 14;
  } else {
    for(const r of risks){
      doc.text(`‚Ä¢ (${r.n}x) ${r.txt}`, 40, y, { maxWidth: 520 }); y += 14;
      if(y > 760){ doc.addPage(); y = 52; }
    }
  }

  y += 8;
  doc.setFont("helvetica", "bold");
  doc.text("Perguntas mais prov√°veis na banca (treine MUITO)", 40, y); y += 14;
  doc.setFont("helvetica", "normal");

  qLikely.forEach((q, i) => {
    doc.text(`${i+1}. ${q.text}`, 40, y, { maxWidth: 520 }); y += 22;
    if(y > 760){ doc.addPage(); y = 52; }
  });

  y += 6;
  doc.setFont("helvetica", "bold");
  doc.text("Estrat√©gias de sobreviv√™ncia (frases de escape)", 40, y); y += 14;

  doc.setFont("helvetica", "normal");
  const escapes = [
    "‚Ä¢ ‚ÄúExcelente pergunta. Esse ponto foge do escopo do estudo, mas abre uma agenda futura objetiva: ______.‚Äù",
    "‚Ä¢ ‚ÄúNo meu desenho atual eu n√£o consigo afirmar causalidade, apenas associa√ß√£o. Para causalidade eu precisaria de ______.‚Äù",
    "‚Ä¢ ‚ÄúA limita√ß√£o principal √© ______. Eu mitiguei com ______, ent√£o a conclus√£o deve ser lida como ______.‚Äù",
    "‚Ä¢ ‚ÄúUma interpreta√ß√£o alternativa √© ______. Eu favore√ßo minha interpreta√ß√£o porque ______.‚Äù"
  ];
  escapes.forEach(line => {
    doc.text(line, 40, y, { maxWidth: 520 }); y += 16;
    if(y > 760){ doc.addPage(); y = 52; }
  });

  y += 8;
  doc.setFont("helvetica", "bold");
  doc.text("Registro do treino (amostra)", 40, y); y += 14;
  doc.setFont("helvetica", "normal");
  const last = session.answers.slice(-6);
  last.forEach((a, i) => {
    doc.text(`Q${session.answers.length - last.length + i + 1}: ${a.q.text}`, 40, y, { maxWidth: 520 }); y += 16;
    doc.text(`Sua resposta (resumo): ${a.answer.slice(0, 180)}${a.answer.length>180?"‚Ä¶":""}`, 40, y, { maxWidth: 520 }); y += 22;
    if(y > 760){ doc.addPage(); y = 52; }
  });

  doc.save(`guru-de-banca_relatorio_${name.replace(/\s+/g,"_")}.pdf`);
}

/* =========================
   MAIN ACTIONS
========================= */
function buildCtx(){
  return {
    studentName: $("studentName").value.trim(),
    level: $("level").value,
    area: $("area").value,
    severity: $("severity").value,
  };
}

async function startWithPdf(){
  const file = $("pdfInput").files?.[0];
  const ctx = buildCtx();

  if(!file){
    toast("Sem PDF", "Carregue um PDF ou use o modo DEMO.");
    return;
  }

  toast("Lendo PDF", "Extraindo texto‚Ä¶ (seu navegador vai trabalhar um pouco)");
  let extracted;
  try{
    extracted = await extractPdfText(file);
  } catch(e){
    console.error(e);
    toast("Erro no PDF", "N√£o consegui ler esse PDF. Tente outro arquivo ou o modo DEMO.");
    return;
  }

  const words = wordsCount(extracted.text);
  const meta = detectSections(extracted.text);

  session = makeEmptySession(ctx, meta);
  session.meta.pages = extracted.pages;
  session.meta.words = words;
  session.meta.rawText = extracted.text.slice(0, 220000); // limite para n√£o explodir storage

  // perguntas
  session.questions = buildQuestionBank({ level: ctx.level, area: ctx.area, severity: ctx.severity, meta });
  session.qi = 0;
  session.answers = [];

  saveSession();

  renderMeta(meta, extracted.pages, words);
  $("qTotal").textContent = String(session.questions.length);
  renderQuestion();
  toast("Pronto", "Vamos come√ßar. Responda como se estivesse na frente da banca.");
}

function startDemo(){
  const ctx = buildCtx();
  const demoText = `
  T√≠tulo: Efeitos de vari√°veis ambientais na din√¢mica de um ecossistema urbano.
  Introdu√ß√£o: Este trabalho discute...
  Objetivo geral: avaliar a rela√ß√£o entre temperatura e um indicador ambiental.
  Objetivos espec√≠ficos: (1) descrever padr√µes, (2) testar associa√ß√£o...
  Metodologia: s√©ries temporais e an√°lise estat√≠stica com modelos...
  Resultados: observou-se aumento...
  Discuss√£o: interpreta√ß√µes...
  Conclus√£o: recomenda√ß√µes...
  Limita√ß√µes: amostra e sazonalidade...
  Refer√™ncias: ...
  `;
  const meta = detectSections(demoText);
  session = makeEmptySession(ctx, meta);
  session.meta.pages = 12;
  session.meta.words = wordsCount(demoText);
  session.meta.rawText = demoText;

  session.questions = buildQuestionBank({ level: ctx.level, area: ctx.area, severity: ctx.severity, meta });
  session.qi = 0;
  session.answers = [];

  saveSession();

  renderMeta(meta, session.meta.pages, session.meta.words);
  $("qTotal").textContent = String(session.questions.length);
  renderQuestion();
  toast("DEMO ativo", "Isso √© apenas simula√ß√£o sem PDF real. Para valer, fa√ßa upload do PDF.");
}

function resume(){
  const s = loadSession();
  if(!s){
    toast("Nada salvo", "N√£o encontrei sess√£o salva neste navegador.");
    return;
  }
  session = s;
  setModePill();
  renderMeta(session.meta, session.meta.pages, session.meta.words);
  $("qTotal").textContent = String(session.questions.length);
  renderQuestion();
  toast("Retomado", "Sess√£o carregada. Continue a simula√ß√£o.");
}

function answerFlow(){
  if(!session){
    toast("Sem sess√£o", "Fa√ßa upload/an√°lise ou use o modo DEMO.");
    return;
  }
  const q = session.questions[session.qi];
  if(!q){
    toast("Fim", "Sem mais perguntas. Gere o relat√≥rio.");
    return;
  }
  const ans = $("answer").value.trim();
  if(!ans){
    toast("Cad√™ a resposta?", "Em banca, sil√™ncio n√£o pontua. Escreva algo objetivo.");
    return;
  }

  const score = evaluateAnswer(q, ans, session.ctx);

  // follow-up (pode variar pela severidade)
  let follow = q.follow;
  if(session.ctx.severity === "hard"){
    // faz follow-up mais agressivo se a resposta foi ruim
    const a = avgScore(score);
    if(a < 6.2){
      follow = "Ok, mas isso N√ÉO respondeu a pergunta. Reformule em 2 frases: ponto + evid√™ncia. Agora.";
    } else if(a < 7.2){
      follow = "Certo, mas onde est√° a sua evid√™ncia? Me d√™ o dado/crit√©rio e a limita√ß√£o na mesma resposta.";
    }
  }

  session.answers.push({ q, answer: ans, score, at: nowISO() });

  saveSession();
  renderFeedback(score, follow);

  // atualizar nota/progresso
  const done = session.answers.length;
  const total = session.questions.length;
  $("qDone").textContent = String(done);
  $("progressFill").style.width = total ? pct(done/total) : "0%";
  $("liveGrade").textContent = computeGrade(session).final.toFixed(1);
}

function nextQuestion(){
  if(!session) return;
  session.qi++;
  if(session.qi >= session.questions.length){
    toast("Acabou", "Voc√™ terminou as perguntas. Gere o relat√≥rio final.");
    session.qi = session.questions.length; // clamp
    saveSession();
    renderQuestion();
    return;
  }
  saveSession();
  renderQuestion();
}

async function finish(){
  if(!session){
    toast("Sem sess√£o", "Fa√ßa upload/an√°lise ou use o modo DEMO.");
    return;
  }
  if(session.answers.length < 4){
    toast("Pouco treino", "Responda pelo menos 4 perguntas antes de gerar o relat√≥rio (sen√£o vira chute).");
    return;
  }
  toast("Gerando PDF", "Montando seu relat√≥rio final‚Ä¶");
  await generatePdfReport(session);
  toast("Relat√≥rio pronto", "PDF baixado. Agora treine as perguntas prov√°veis e repita o simulado.");
}

/* =========================
   BUTTONS
========================= */
$("btnAnalyze").addEventListener("click", startWithPdf);
$("btnLoadDemo").addEventListener("click", startDemo);
$("btnResume").addEventListener("click", resume);
$("btnReset").addEventListener("click", resetSession);

$("btnAnswer").addEventListener("click", answerFlow);
$("btnHint").addEventListener("click", ()=>{
  if(!session) return toast("Sem sess√£o","Fa√ßa upload/an√°lise ou use DEMO.");
  const q = session.questions[session.qi];
  const hint =
    q.tags.includes("core") ? "Estruture em 2‚Äì3 frases: **problema/objetivo** + **por que importa** + **o que voc√™ fez**." :
    q.tags.includes("metodo") ? "Diga: **por que escolheu** + **o que controla** + **o que n√£o controla (limite)**." :
    q.tags.includes("estatistica") ? "Diga: **o que voc√™ estima** + **qual suposi√ß√£o** + **como mede incerteza**." :
    q.tags.includes("teoria") ? "Diga: **conceito central** + **autor/linha** + **como voc√™ operacionaliza**." :
    "Diga: **achado** + **evid√™ncia** + **alternativa** + **limita√ß√£o**.";
  toast("Dica de banca", hint, 3200);
});

$("btnIDK").addEventListener("click", ()=>{
  $("answer").value =
`Eu n√£o tenho esse detalhe de mem√≥ria agora, mas posso responder com transpar√™ncia:
(1) O que eu consigo afirmar com seguran√ßa √©: ______.
(2) O que eu precisaria consultar/rodar para responder exatamente √©: ______.
(3) Isso n√£o invalida o trabalho porque: ______.
(4) Como agenda futura, eu faria: ______.`;
  toast("Boa estrat√©gia", "Use isso para N√ÉO travar na banca. Agora complete os campos.");
});

$("btnNext").addEventListener("click", nextQuestion);
$("btnFinish").addEventListener("click", finish);

/* init */
renderIdle();
</script>
</body>
</html>
