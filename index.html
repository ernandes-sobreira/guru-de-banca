<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GURU DE BANCA ‚Äî v2</title>

  <!-- PDF.js (opcional) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg1:#f7fbff;
      --bg2:#fff7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:rgba(15,23,42,.12);
      --shadow:0 18px 50px rgba(2,6,23,.10);
      --r:18px;

      --p:#7c3aed;   /* roxo */
      --b:#0ea5e9;   /* azul */
      --g:#22c55e;   /* verde */
      --y:#f59e0b;   /* amarelo */
      --r2:#ef4444;  /* vermelho */
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 10% 10%, rgba(14,165,233,.20), transparent 60%),
        radial-gradient(900px 520px at 90% 20%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 520px at 20% 90%, rgba(34,197,94,.16), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:9;
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{ max-width:1160px; margin:0 auto; padding:16px; }

    .top{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 210deg, var(--p), var(--b), var(--g), var(--y), var(--p));
      box-shadow: var(--shadow);
    }
    h1{ margin:0; font-size:16px; letter-spacing:.3px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.7);
      padding:8px 10px; border-radius:999px;
      box-shadow: 0 10px 26px rgba(2,6,23,.06);
    }

    main{ padding:18px 0 54px; }
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background: linear-gradient(90deg, rgba(124,58,237,.10), rgba(14,165,233,.08), rgba(34,197,94,.08));
    }
    .hd h2{ margin:0; font-size:14px; letter-spacing:.3px; }
    .hd .hint{ font-size:12px; color:var(--muted); line-height:1.2; }
    .bd{ padding:14px; }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="file"], select, textarea, input[type="text"], input[type="number"]{
      width:100%;
      background: rgba(2,6,23,.03);
      border:1px solid var(--line);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
    }
    textarea{ min-height:130px; resize:vertical; }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 560px){ .row{ grid-template-columns:1fr; } }

    .btns{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }

    button{
      border:0;
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:800;
      color:#fff;
      background: linear-gradient(135deg, var(--p), var(--b));
      box-shadow: 0 14px 28px rgba(124,58,237,.18);
      transition: transform .05s ease;
    }
    button:active{ transform: translateY(1px); }
    button.secondary{
      color:var(--text);
      background: rgba(255,255,255,.9);
      border:1px solid var(--line);
      box-shadow: 0 14px 28px rgba(2,6,23,.06);
    }
    button.good{
      background: linear-gradient(135deg, var(--g), rgba(34,197,94,.78));
      box-shadow: 0 14px 28px rgba(34,197,94,.18);
    }
    button.warn{
      background: linear-gradient(135deg, var(--y), rgba(245,158,11,.78));
      box-shadow: 0 14px 28px rgba(245,158,11,.18);
    }
    button.danger{
      background: linear-gradient(135deg, var(--r2), rgba(239,68,68,.78));
      box-shadow: 0 14px 28px rgba(239,68,68,.18);
    }

    .kpis{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 760px){ .kpis{ grid-template-columns:1fr 1fr; } }
    .kpi{
      border:1px solid var(--line);
      background: rgba(255,255,255,.9);
      border-radius: 16px;
      padding:10px 12px;
    }
    .kpi .v{ font-size:18px; font-weight:900; }
    .kpi .t{ font-size:12px; color:var(--muted); margin-top:4px; }

    .hr{ height:1px; background: var(--line); margin:12px 0; }

    .committee{
      border:1px dashed rgba(15,23,42,.18);
      background: rgba(14,165,233,.06);
      border-radius:16px;
      padding:12px;
    }
    .committee h3{ margin:0 0 10px; font-size:13px; }
    .committeeList{
      display:flex; flex-direction:column; gap:10px;
    }
    .member{
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      border-radius: 14px;
      padding:10px;
    }
    .memberTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .memberTop b{ font-size:13px; }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chip{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.9);
      color: var(--muted);
    }

    .prof{
      display:flex; gap:12px; align-items:flex-start;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
    }
    .avatar{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 210deg, var(--y), var(--p), var(--b), var(--g), var(--y));
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .prof .name{ font-weight:900; font-size:13px; }
    .prof .role{ color:var(--muted); font-size:12px; margin-top:2px; }
    .prof .msg{ margin-top:8px; font-size:13px; line-height:1.35; }

    .tags{ margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(124,58,237,.08);
      color: rgba(124,58,237,.95);
    }

    .feedback{
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      border-radius: 16px;
      padding:12px;
      margin-top:12px;
    }
    .feedback h3{ margin:0 0 6px; font-size:13px; }
    .small{ font-size:12px; color:var(--muted); }
    .list{ margin:8px 0 0; padding-left:18px; }
    .list li{ margin:6px 0; }

    .bar{
      height:10px; border-radius:999px; background: rgba(2,6,23,.06);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .fill{
      height:100%; width:0%;
      background: linear-gradient(90deg, var(--r2), var(--y), var(--g));
    }

    .toast{
      position:fixed; right:16px; bottom:16px;
      background: rgba(255,255,255,.96);
      border:1px solid var(--line);
      color: var(--text);
      padding:12px 12px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      max-width: 380px;
      z-index:999;
    }
    .toast .t{ font-weight:900; font-size:13px; }
    .toast .b{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35; }
    .hide{ display:none !important; }

    /* Confetti overlay */
    #confettiCanvas{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:998;
    }
  </style>
</head>

<body>
<canvas id="confettiCanvas"></canvas>

<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>GURU DE BANCA</h1>
        <div class="sub">Banca realista, chata e √∫til ‚Äî baseada no seu resumo (PDF √© opcional)</div>
      </div>
    </div>
    <div class="pill">Modo: <span id="modePill">‚Äî</span></div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- LEFT -->
    <section class="card">
      <div class="hd">
        <div>
          <h2>1) Dados do trabalho + banca</h2>
          <div class="hint">
            Cole o <b>resumo</b> (obrigat√≥rio). O PDF pode falhar se for escaneado (imagem).  
            Com o resumo, eu te aperto com perguntas <b>espec√≠ficas</b>.
          </div>
        </div>
      </div>

      <div class="bd">
        <label>Seu nome (vai no relat√≥rio)</label>
        <input id="studentName" type="text" placeholder="Ex: Ernandes" />

        <div style="height:10px"></div>

        <div class="row">
          <div>
            <label>N√≠vel</label>
            <select id="level">
              <option value="tcc">TCC</option>
              <option value="msc">Mestrado</option>
              <option value="phd">Doutorado</option>
            </select>
          </div>
          <div>
            <label>√Årea</label>
            <select id="area">
              <option value="bio">Biol√≥gicas/Ambientais</option>
              <option value="exa">Exatas/Tecnologia</option>
              <option value="hum">Humanas/Sociais</option>
              <option value="int">Interdisciplinar</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div>
            <label>Tipo de estudo</label>
            <select id="studyType">
              <option value="quant">Quantitativo</option>
              <option value="qual">Qualitativo</option>
              <option value="mixed">Misto</option>
              <option value="theory">Te√≥rico/Conceitual</option>
              <option value="applied">Aplicado/Interven√ß√£o</option>
              <option value="review">Revis√£o (sist./narrativa)</option>
            </select>
          </div>
          <div>
            <label>N√≠vel da banca</label>
            <select id="severity">
              <option value="calm">Tranquila</option>
              <option value="tech">T√©cnica</option>
              <option value="hard" selected>Chata</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <label>Resumo/Abstract do trabalho (OBRIGAT√ìRIO)</label>
        <textarea id="abstractText" placeholder="Cole aqui o resumo do trabalho. √â disso que eu vou tirar as perguntas (objetivo, m√©todo, dados, contribui√ß√£o, limites)."></textarea>

        <div style="height:10px"></div>

        <label>Upload do PDF (OPCIONAL ‚Äî pode falhar se for escaneado)</label>
        <input id="pdfInput" type="file" accept="application/pdf" />

        <div style="height:10px"></div>

        <div class="row">
          <div>
            <label>Quantidade de perguntas</label>
            <input id="nQuestions" type="number" min="8" max="60" value="24" />
          </div>
          <div>
            <label>Mistura de dificuldade</label>
            <select id="difficultyMix">
              <option value="balanced" selected>Balanceado (30% f√°cil / 40% m√©dia / 30% dif√≠cil)</option>
              <option value="easy">Mais f√°cil (50/35/15)</option>
              <option value="hard">Mais dif√≠cil (20/35/45)</option>
              <option value="random">Total aleat√≥rio</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="committee">
          <h3>2) Sua banca (nomes + perfis)</h3>

          <div class="row">
            <div>
              <label>Nome do avaliador(a)</label>
              <input id="memberName" type="text" placeholder="Ex: Profa. Maria" />
            </div>
            <div>
              <label>Perfil (pode escolher mais de um depois)</label>
              <select id="memberPrimary">
                <option value="method">Metodol√≥gico(a)</option>
                <option value="theory">Te√≥rico(a)</option>
                <option value="stats">Estat√≠stico(a)</option>
                <option value="qual">Qualitativo(a)</option>
                <option value="critical">Cr√≠tico(a) / Implicante</option>
                <option value="practical">Pr√°tico(a) / Pol√≠ticas p√∫blicas</option>
                <option value="nice">Bonzinho(a)</option>
              </select>
            </div>
          </div>

          <div class="btns">
            <button class="good" id="btnAddMember">Adicionar avaliador</button>
            <button class="secondary" id="btnAdd3Default">Criar banca padr√£o (3)</button>
          </div>

          <div class="committeeList" id="committeeList"></div>
        </div>

        <div class="btns">
          <button class="good" id="btnStart">Analisar e come√ßar simula√ß√£o</button>
          <button class="secondary" id="btnDemo">Carregar DEMO real</button>
          <button class="secondary" id="btnResume">Retomar sess√£o salva</button>
          <button class="danger" id="btnReset">Resetar tudo</button>
        </div>

        <div class="hr"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="v" id="kpiAnchor">‚Äî</div>
            <div class="t">√Çncoras no resumo</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiPDF">‚Äî</div>
            <div class="t">PDF (texto extra√≠do)</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiQ">‚Äî</div>
            <div class="t">Perguntas geradas</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiConf">‚Äî</div>
            <div class="t">Diagn√≥stico</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="small" id="digest"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="hd">
        <div>
          <h2>3) Simulador de banca (f√°cil ‚Üí dif√≠cil, aleat√≥rio)</h2>
          <div class="hint">Pergunta ‚Üí resposta ‚Üí repregunta chata ‚Üí feedback. No final: festa + relat√≥rio em PDF.</div>
        </div>
      </div>

      <div class="bd">
        <div class="prof">
          <div class="avatar"></div>
          <div>
            <div class="name" id="whoName">Professor(a) da banca</div>
            <div class="role" id="whoRole">‚Äî</div>
            <div class="msg" id="qText">Cole o resumo e clique em <b>Analisar e come√ßar</b> (ou carregue o DEMO).</div>
            <div class="tags" id="qTags"></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <label>Sua resposta (objetiva ‚Äî sem enrolar)</label>
        <textarea id="answer" placeholder="Estrutura que salva na banca: (1) ponto central, (2) evid√™ncia, (3) limite, (4) implica√ß√£o."></textarea>

        <div class="btns">
          <button id="btnAnswer">Responder</button>
          <button class="secondary" id="btnHint">Pedir dica</button>
          <button class="secondary" id="btnIDK">N√£o sei responder</button>
        </div>

        <div class="feedback hide" id="fbBox">
          <h3 id="fbTitle">Feedback (banca chata)</h3>
          <div class="small" id="fbSummary">‚Äî</div>
          <ul class="list" id="fbList"></ul>

          <div class="hr"></div>
          <div class="small">Repregunta:</div>
          <div style="margin-top:8px; font-weight:900" id="followQ">‚Äî</div>

          <div class="btns">
            <button class="good" id="btnNext">Pr√≥xima pergunta</button>
            <button class="warn" id="btnFinish">Finalizar + relat√≥rio</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="small">Progresso</div>
        <div class="bar" style="margin-top:8px;"><div class="fill" id="progFill"></div></div>

        <div class="small" style="margin-top:8px;">
          Respondidas: <b id="done">0</b> / <b id="total">0</b> ‚Ä¢ Nota parcial: <b id="liveGrade">‚Äî</b> ‚Ä¢ Humor da banca: <b id="mood">‚Äî</b>
        </div>
      </div>
    </aside>

  </div>
</main>

<div id="toast" class="toast hide">
  <div class="t" id="toastT">‚Äî</div>
  <div class="b" id="toastB">‚Äî</div>
</div>

<script>
/* ======================
   UTIL
====================== */
const $ = (id)=>document.getElementById(id);
const SESSION_KEY = "guru_banca_v2";

function toast(t,b,ms=2600){
  $("toastT").textContent=t;
  $("toastB").textContent=b;
  $("toast").classList.remove("hide");
  setTimeout(()=> $("toast").classList.add("hide"), ms);
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function nowISO(){
  const d=new Date();
  return d.toISOString().slice(0,19).replace("T"," ");
}
function wordsCount(s){ return (s||"").trim().split(/\s+/).filter(Boolean).length; }
function sample(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function pct(n){ return Math.round(n*100) + "%"; }

/* ======================
   CONFETTI (canvas)
====================== */
const confetti = (() => {
  const canvas = $("confettiCanvas");
  const ctx = canvas.getContext("2d");
  let W=0,H=0, parts=[], raf=null, endAt=0;

  function resize(){
    W = canvas.width = window.innerWidth * devicePixelRatio;
    H = canvas.height = window.innerHeight * devicePixelRatio;
  }
  window.addEventListener("resize", resize);
  resize();

  function burst(intensity=120, durationMs=1200){
    const colors = ["#7c3aed","#0ea5e9","#22c55e","#f59e0b","#ef4444","#111827"];
    const count = intensity;
    for(let i=0;i<count;i++){
      parts.push({
        x: Math.random()*W,
        y: -20,
        vx:(Math.random()*2-1)*2*devicePixelRatio,
        vy:(Math.random()*2+2)*devicePixelRatio,
        r:(Math.random()*6+3)*devicePixelRatio,
        rot: Math.random()*Math.PI,
        vr:(Math.random()*0.2-0.1),
        c: colors[Math.floor(Math.random()*colors.length)],
        life: 0,
        max: Math.random()*80+60
      });
    }
    endAt = performance.now() + durationMs;
    if(!raf) loop();
  }

  function loop(){
    raf = requestAnimationFrame(loop);
    ctx.clearRect(0,0,W,H);

    parts.forEach(p=>{
      p.life++;
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.03*devicePixelRatio;
      p.rot += p.vr;

      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.c;
      ctx.globalAlpha = 1 - (p.life/p.max);
      ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.7);
      ctx.restore();
    });

    parts = parts.filter(p => p.life < p.max && p.y < H+50);

    if(performance.now() > endAt && parts.length === 0){
      cancelAnimationFrame(raf);
      raf=null;
      ctx.clearRect(0,0,W,H);
    }
  }

  return { burst };
})();

/* ======================
   PDF (optional)
====================== */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

async function extractPdfText(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
  let full = "";
  for(let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const strings = content.items.map(it => it.str);
    full += "\n\n" + strings.join(" ");
  }
  return { pages: pdf.numPages, text: full };
}

/* ======================
   ABSTRACT ANCHORS
   (extrai pistas do resumo)
====================== */
function normalize(s){
  return (s||"").replace(/\s+/g," ").trim();
}
function sentenceSplit(text){
  const t = (text||"").replace(/\n+/g," ");
  const parts = t.split(/(?<=[\.\!\?])\s+/).map(x=>x.trim()).filter(Boolean);
  return parts.length ? parts : [t.trim()].filter(Boolean);
}
function extractAnchors(abstract){
  const a = abstract || "";
  const low = a.toLowerCase();

  // padr√µes comuns (PT/EN)
  const patterns = [
    {k:"objetivo", re: /(objetivo|objetiva|aim|objective)([^\.]{0,180})/i},
    {k:"metodo",   re: /(metodologia|m√©todo|metodos|m√©todos|procedimento|an(√°|a)lise|modelo|entrevista|question(√°|a)rio|ensaio|experimento|amostra|survey|model|interview|questionnaire)([^\.]{0,180})/i},
    {k:"dados",    re: /(dados|data|amostra|n\s*=\s*\d+|\b\d+\s*(participantes|amostras|anos|meses|sites|locais))([^\.]{0,180})/i},
    {k:"resultado",re: /(resultado|resultados|achado|observou|mostrou|indicou|aumentou|reduziu|significativ|we found|results show|indicate)([^\.]{0,180})/i},
    {k:"conclusao",re: /(conclus(√£|a)o|conclui|implica|recomenda|therefore|we conclude|suggest)([^\.]{0,180})/i},
    {k:"limitacao",re: /(limita(√ß|c)(√£|a)o|limita√ß√µes|limitation|constraints)([^\.]{0,180})/i},
    {k:"lacuna",   re: /(lacuna|gap|poucos estudos|scarce|lack of studies)([^\.]{0,180})/i},
  ];

  const anchors = [];
  for(const p of patterns){
    const m = a.match(p.re);
    if(m){
      anchors.push({ key:p.k, snippet: normalize((m[0]||"").slice(0,220)) });
    }
  }

  // pega 2-3 frases ‚Äúmais informativas‚Äù
  const sents = sentenceSplit(a);
  const ranked = sents
    .map(s => ({s, score: scoreInformative(s)}))
    .sort((x,y)=>y.score-x.score)
    .slice(0,3)
    .map(x=>normalize(x.s).slice(0,240));

  ranked.forEach((sn,i)=>anchors.push({key:`frase_${i+1}`, snippet: sn}));

  // dedup snippets
  const seen = new Set();
  const uniq = [];
  for(const an of anchors){
    const key = an.key + "::" + an.snippet.toLowerCase();
    if(seen.has(key)) continue;
    seen.add(key);
    uniq.push(an);
  }

  return uniq;
}

function scoreInformative(s){
  const low=s.toLowerCase();
  let score = 0;
  if(/\b(n\s*=\s*\d+|\d+)\b/.test(low)) score += 2;
  if(/metod|m√©tod|modelo|entrevista|survey|exper/.test(low)) score += 2;
  if(/resultado|observ|indic|aument|reduz|signific/.test(low)) score += 2;
  if(/objetivo|aim|objective/.test(low)) score += 2;
  if(/conclus|implic|recomend|suggest/.test(low)) score += 1.5;
  return score + Math.min(2, s.length/120);
}

/* ======================
   COMMITTEE
====================== */
let committee = [];

function profileLabel(p){
  return {
    method:"Metodol√≥gico(a)",
    theory:"Te√≥rico(a)",
    stats:"Estat√≠stico(a)",
    qual:"Qualitativo(a)",
    critical:"Cr√≠tico(a)/Implicante",
    practical:"Pr√°tico(a)/Pol√≠ticas p√∫blicas",
    nice:"Bonzinho(a)"
  }[p] || p;
}

function renderCommittee(){
  const box = $("committeeList");
  box.innerHTML = "";
  if(!committee.length){
    box.innerHTML = `<div class="small">Nenhum avaliador cadastrado. Crie uma banca (recomendado 3‚Äì5).</div>`;
    return;
  }
  committee.forEach((m, idx)=>{
    const profiles = (m.profiles||[]).map(p=>`<span class="chip">${profileLabel(p)}</span>`).join("");
    box.innerHTML += `
      <div class="member">
        <div class="memberTop">
          <div><b>${escapeHtml(m.name)}</b> <span class="small">(${m.roleTone})</span></div>
          <div class="btns" style="margin:0;">
            <button class="secondary" data-act="toggle" data-idx="${idx}" style="padding:8px 10px;border-radius:12px;">Editar perfis</button>
            <button class="danger" data-act="del" data-idx="${idx}" style="padding:8px 10px;border-radius:12px;">Remover</button>
          </div>
        </div>
        <div class="chips">${profiles}</div>
        <div class="small" style="margin-top:8px;">
          Perfil define o estilo das perguntas e repreguntas.
        </div>
      </div>
    `;
  });

  // actions
  box.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-act");
      const idx = Number(btn.getAttribute("data-idx"));
      if(act === "del"){
        committee.splice(idx,1);
        renderCommittee();
        saveDraft();
        return;
      }
      if(act === "toggle"){
        editProfiles(idx);
        return;
      }
    });
  });
}

function editProfiles(idx){
  const m = committee[idx];
  const options = [
    ["method","Metodol√≥gico(a)"],
    ["theory","Te√≥rico(a)"],
    ["stats","Estat√≠stico(a)"],
    ["qual","Qualitativo(a)"],
    ["critical","Cr√≠tico(a)/Implicante"],
    ["practical","Pr√°tico(a)/Pol√≠ticas p√∫blicas"],
    ["nice","Bonzinho(a)"]
  ];
  const current = new Set(m.profiles||[]);
  const pick = options.map(([k,label]) => `${current.has(k) ? "[x]" : "[ ]"} ${label}`).join("\n");

  const raw = prompt(
`Editar perfis de: ${m.name}
Marque perfis digitando uma lista separada por v√≠rgula com os c√≥digos:
method, theory, stats, qual, critical, practical, nice

Perfis atuais:
${pick}

Exemplo: method, stats, critical`,
(m.profiles||[]).join(", ")
  );

  if(raw === null) return;
  const tokens = raw.split(",").map(x=>x.trim()).filter(Boolean);
  const valid = new Set(options.map(x=>x[0]));
  const cleaned = [...new Set(tokens.filter(t=>valid.has(t)))];
  if(!cleaned.length){
    toast("Ops", "Voc√™ precisa manter pelo menos 1 perfil.");
    return;
  }
  m.profiles = cleaned;
  m.roleTone = roleToneFromProfiles(cleaned);
  renderCommittee();
  saveDraft();
}

function roleToneFromProfiles(profiles){
  // define ‚Äútom dominante‚Äù
  if(profiles.includes("nice")) return "leve";
  if(profiles.includes("critical")) return "duro";
  if(profiles.includes("stats") || profiles.includes("method")) return "t√©cnico";
  if(profiles.includes("theory")) return "conceitual";
  if(profiles.includes("qual")) return "interpretativo";
  if(profiles.includes("practical")) return "aplicado";
  return "t√©cnico";
}

function addMember(name, primary){
  const n = (name||"").trim();
  if(!n) return toast("Cad√™ o nome?", "Digite o nome do avaliador(a).");
  const profiles = [primary];
  committee.push({ name:n, profiles, roleTone: roleToneFromProfiles(profiles) });
  $("memberName").value = "";
  renderCommittee();
  saveDraft();
}

/* ======================
   QUESTION BANK (anchored)
====================== */
function makeQuestionBank(ctx, anchors){
  const { level, severity, studyType, area } = ctx;

  // helpers: gera perguntas com √¢ncora
  const A = () => sample(anchors)?.snippet || "(trecho do seu resumo)";
  const pickAnchorByKey = (key) => {
    const hit = anchors.find(x=>x.key===key);
    return hit ? hit.snippet : A();
  };

  // Dificuldade: easy/med/hard
  // tags: core, method, stats, qual, theory, results, limits, ethics, practical, trap
  const bank = [];

  // CORE ancorado
  bank.push(
    q("core_e1", "easy", ["core","clareza"], "qualquer",
      (m)=>`(${m.name}) Em 1 frase: qual √© o problema central do seu estudo, do jeito que aparece no seu resumo?`,
      ()=>`Qual a evid√™ncia no resumo que mostra que isso √© um problema real (n√£o s√≥ curiosidade)?`,
      "Enrolar, dar contexto demais, n√£o definir o problema.",
      "Ponto central em 1 frase + 'importa porque...' em 1 frase."
    ),
    q("core_m1", "med", ["core","objetivos"], "qualquer",
      (m)=>`(${m.name}) No seu resumo, o objetivo parece ser: "${pickAnchorByKey("objetivo")}". Transforme isso em 2 objetivos espec√≠ficos verific√°veis.`,
      ()=>`Qual objetivo espec√≠fico √© o mais fraco? O que voc√™ mudaria nele?`,
      "Objetivos gen√©ricos ou n√£o test√°veis.",
      "Objetivo espec√≠fico tem verbo de a√ß√£o + vari√°vel/objeto + crit√©rio de avalia√ß√£o."
    ),
    q("core_h1", "hard", ["core","contribuicao","trap"], "qualquer",
      (m)=>`(${m.name}) Seja honesto(a): qual √© a contribui√ß√£o original do seu trabalho? Se eu disser que isso √© 'mais do mesmo', como voc√™ rebate?`,
      ()=>`Qual trabalho da literatura voc√™ est√° estendendo/contrariando (sem citar 20 autores)?`,
      "Dizer 'falta estudo' como contribui√ß√£o.",
      "Contribui√ß√£o = 'o que voc√™ adiciona' + 'para quem' + 'por qu√™ agora'."
    )
  );

  // por tipo de estudo
  if(studyType === "quant" || studyType === "mixed" || studyType === "applied"){
    bank.push(
      q("m_e1","easy",["method","coerencia"],"method",
        (m)=>`(${m.name}) No seu resumo, voc√™ afirma: "${pickAnchorByKey("metodo")}". Por que esse delineamento √© adequado para responder seu objetivo?`,
        ()=>`Qual alternativa metodol√≥gica voc√™ considerou e por que descartou?`,
        "M√©todo escolhido 'porque era o que dava'.",
        "Defenda m√©todo com: adequa√ß√£o ‚Üí vi√©s controlado ‚Üí limite assumido."
      ),
      q("s_m1","med",["stats","incerteza"],"stats",
        (m)=>`(${m.name}) Que suposi√ß√µes a sua an√°lise/modelo faz? E como voc√™ verificou (ou verificaria) essas suposi√ß√µes?`,
        ()=>`Se uma suposi√ß√£o falhar, qual conclus√£o cai primeiro?`,
        "Rodar teste/modelo sem checar suposi√ß√µes.",
        "Fale em diagn√≥stico, sensibilidade, robustez e incerteza."
      ),
      q("s_h1","hard",["stats","causalidade","trap"],"stats",
        (m)=>`(${m.name}) No seu resumo voc√™ sugere efeito/associa√ß√£o: "${pickAnchorByKey("resultado")}". Isso √© causalidade ou associa√ß√£o? O que falta para ser causal?`,
        ()=>`Qual vari√°vel de confus√£o mais prov√°vel est√° escondida a√≠?`,
        "Confundir correla√ß√£o com causalidade.",
        "Diga: associa√ß√£o ‚Üí plausibilidade ‚Üí confus√£o ‚Üí desenho/experimento necess√°rio."
      )
    );
  }

  if(studyType === "qual" || studyType === "mixed"){
    bank.push(
      q("q_e1","easy",["qual","rigor"],"qual",
        (m)=>`(${m.name}) Em qualitativo, rigor n√£o √© 'achar bonito'. Como voc√™ garante credibilidade/consist√™ncia (triangula√ß√£o, satura√ß√£o, valida√ß√£o, auditoria)?`,
        ()=>`Se eu disser: "isso √© s√≥ opini√£o", qual √© sua resposta t√©cnica?`,
        "N√£o definir crit√©rios de rigor qualitativo.",
        "Use linguagem de rigor: satura√ß√£o, triangula√ß√£o, rastreabilidade, reflexividade."
      ),
      q("q_m1","med",["qual","amostragem"],"qual",
        (m)=>`(${m.name}) Como voc√™ definiu participantes/casos? Que tipo de amostragem (intencional, bola de neve etc.) e por qu√™?`,
        ()=>`Que vi√©s essa amostragem pode introduzir?`,
        "Amostra por conveni√™ncia sem cr√≠tica.",
        "Diga: crit√©rio de inclus√£o ‚Üí satura√ß√£o ‚Üí limita√ß√µes."
      ),
      q("q_h1","hard",["qual","trap","interpretacao"],"critical",
        (m)=>`(${m.name}) Mostre que voc√™ sabe separar dado e interpreta√ß√£o. Me d√™ um exemplo (do seu trabalho) de onde voc√™ pode estar interpretando demais.`,
        ()=>`Como voc√™ reescreveria essa parte para ficar mais defens√°vel?`,
        "Misturar resultado com opini√£o.",
        "Estruture: evid√™ncia (fala/c√≥digo) ‚Üí interpreta√ß√£o ‚Üí limite."
      )
    );
  }

  if(studyType === "review"){
    bank.push(
      q("rv_e1","easy",["method","review"],"method",
        (m)=>`(${m.name}) Sua revis√£o √© sistem√°tica, escopo, ou narrativa? O que define isso metodologicamente?`,
        ()=>`Se eu pedir reprodutibilidade, o que voc√™ mostra (strings, bases, crit√©rios)?`,
        "Chamar tudo de sistem√°tica sem m√©todo.",
        "Defina protocolo, crit√©rios, bases, sele√ß√£o e vi√©s."
      ),
      q("rv_m1","med",["method","review","vi√©s"],"method",
        (m)=>`(${m.name}) Onde sua revis√£o pode estar enviesada (bases, idioma, recorte temporal, crit√©rios)?`,
        ()=>`Qual medida pr√°tica voc√™ tomou para reduzir esse vi√©s?`,
        "Ignorar vi√©s de publica√ß√£o/sele√ß√£o.",
        "Mostre transpar√™ncia: crit√©rios e limita√ß√µes."
      ),
      q("rv_h1","hard",["review","contribuicao","trap"],"critical",
        (m)=>`(${m.name}) Qual s√≠ntese voc√™ produziu que N√ÉO √© s√≥ 'lista de estudos'? Qual insight novo emergiu?`,
        ()=>`Se eu te pedir 1 figura/estrutura conceitual, qual seria?`,
        "Revis√£o sem s√≠ntese.",
        "Contribui√ß√£o = mapa conceitual, lacunas, agenda de pesquisa."
      )
    );
  }

  if(studyType === "theory"){
    bank.push(
      q("th_e1","easy",["theory","conceitos"],"theory",
        (m)=>`(${m.name}) Defina operacionalmente seus 2 conceitos centrais. Como eles aparecem no mundo real?`,
        ()=>`Se eu mudar sua defini√ß√£o, o que muda na sua conclus√£o?`,
        "Conceitos vagos, sem operacionaliza√ß√£o.",
        "Defini√ß√£o + implica√ß√£o + fronteira do conceito."
      ),
      q("th_m1","med",["theory","lacuna"],"theory",
        (m)=>`(${m.name}) Qual lacuna EXATA voc√™ preenche? N√£o vale 'faltam estudos'.`,
        ()=>`Quem √© o principal autor/linha que voc√™ est√° estendendo?`,
        "Lacuna gen√©rica.",
        "Lacuna = pergunta espec√≠fica n√£o respondida + por que agora."
      ),
      q("th_h1","hard",["theory","trap","coerencia"],"critical",
        (m)=>`(${m.name}) Qual √© a cr√≠tica mais forte que algu√©m faria ao seu argumento? Fa√ßa por mim, sem d√≥.`,
        ()=>`Agora se defenda: qual √© o seu melhor contra-argumento?`,
        "Ignorar obje√ß√µes.",
        "Mostre maturidade: melhor cr√≠tica + resposta consistente."
      )
    );
  }

  // RESULTADOS / DISCUSS√ÉO / LIMITES (para todos)
  bank.push(
    q("r_m1","med",["results","evidencia"],"critical",
      (m)=>`(${m.name}) Qual √© o seu achado mais forte? Use o resumo: "${pickAnchorByKey("resultado")}". Qual a evid√™ncia e qual a interpreta√ß√£o?`,
      ()=>`Qual explica√ß√£o alternativa plaus√≠vel existe para esse achado?`,
      "S√≥ repetir resultado sem explicar evid√™ncia/alternativa.",
      "Achado + evid√™ncia + alternativa + por que voc√™ prefere sua leitura."
    ),
    q("l_m1","med",["limits","honestidade"],"method",
      (m)=>`(${m.name}) No seu resumo, qual limita√ß√£o voc√™ admitiu? Se n√£o admitiu, voc√™ j√° come√ßou errado. Diga uma limita√ß√£o real e seu impacto.`,
      ()=>`Como isso muda a for√ßa da sua conclus√£o (forte ‚Üí moderada ‚Üí fraca)?`,
      "N√£o assumir limita√ß√£o.",
      "Limita√ß√£o real + impacto + mitiga√ß√£o + agenda futura."
    ),
    q("p_e1","easy",["practical","impacto"],"practical",
      (m)=>`(${m.name}) Se eu for gestor/pol√≠tica p√∫blica: qual recomenda√ß√£o pr√°tica sai do seu trabalho? (sem prometer o que voc√™ n√£o mediu)`,
      ()=>`O que pode dar errado se aplicarem sua recomenda√ß√£o fora do seu contexto?`,
      "Promessas al√©m do dado.",
      "Recomenda√ß√£o = condicional + limites + cen√°rio de aplica√ß√£o."
    )
  );

  // √âTICA (mais forte em banca t√©cnica/chata)
  if(severity !== "calm"){
    bank.push(
      q("e_m1","med",["ethics","risco"],"critical",
        (m)=>`(${m.name}) Existe risco √©tico, vi√©s social, impacto em grupos, privacidade, dano indireto? Onde est√° seu cuidado com isso?`,
        ()=>`Se algu√©m questionar isso na banca, qual √© sua resposta objetiva em 20 segundos?`,
        "Ignorar √©tica/impacto.",
        "Reconhe√ßa risco + mitiga√ß√£o + limita√ß√£o."
      )
    );
  }

  // Pegadinhas ‚Äúchatas‚Äù quando severity hard
  if(severity === "hard"){
    bank.push(
      q("trap_h1","hard",["trap","coerencia"],"critical",
        (m)=>`(${m.name}) Eu n√£o estou convencido(a) que seu m√©todo responde ao objetivo. Prove em 2 frases usando o resumo: "${pickAnchorByKey("objetivo")}".`,
        ()=>`Qual ajuste m√≠nimo voc√™ faria para alinhar 100% objetivo‚Üîm√©todo?`,
        "Desalinhamento objetivo-m√©todo.",
        "Mostre o encadeamento: objetivo ‚Üí vari√°vel/dado ‚Üí m√©todo ‚Üí evid√™ncia."
      ),
      q("trap_h2","hard",["trap","perguntamaldita"],"critical",
        (m)=>`(${m.name}) Qual parte do seu trabalho pode ser s√≥ ru√≠do/artefato? Onde voc√™ pode estar se enganando?`,
        ()=>`Qual an√°lise/checagem extra reduziria essa d√∫vida?`,
        "Confian√ßa excessiva.",
        "Maturidade: reconhecer d√∫vida + propor checagem."
      )
    );
  }

  // Ajuste por n√≠vel (Doutorado exige mais)
  if(level === "phd"){
    bank.push(
      q("phd_h1","hard",["core","originalidade","trap"],"theory",
        (m)=>`(${m.name}) Em doutorado, eu cobro originalidade. Qual √© a tese (no sentido forte) que voc√™ defende?`,
        ()=>`Se eu discordar da tese, qual evid√™ncia-chave voc√™ usa para me convencer?`,
        "Doutorado sem tese forte.",
        "Tese = afirma√ß√£o ousada + base emp√≠rica + limites."
      )
    );
  }

  // Ajuste por √°rea
  if(area === "exa"){
    bank.push(
      q("exa_m1","med",["method","pipeline"],"method",
        (m)=>`(${m.name}) Qual etapa do seu pipeline √© mais vulner√°vel a erro (pr√©-processamento, par√¢metro, valida√ß√£o, implementa√ß√£o)?`,
        ()=>`Como voc√™ testou que n√£o √© bug/artefato?`,
        "N√£o validar pipeline.",
        "Valida√ß√£o cruzada, testes, verifica√ß√£o, rastreabilidade."
      )
    );
  }
  if(area === "bio"){
    bank.push(
      q("bio_m1","med",["method","controle"],"method",
        (m)=>`(${m.name}) Quais controles (coleta/ambiente/experimental) garantem que seu efeito n√£o √© artefato?`,
        ()=>`Qual vari√°vel ambiental n√£o controlada pode inverter sua interpreta√ß√£o?`,
        "Efeito confundido por ambiente/coleta.",
        "Controle/mitiga√ß√£o + limite."
      )
    );
  }
  if(area === "hum"){
    bank.push(
      q("hum_m1","med",["theory","posicionamento"],"theory",
        (m)=>`(${m.name}) Qual √© seu posicionamento te√≥rico-metodol√≥gico? Qual lente voc√™ usa para interpretar os achados?`,
        ()=>`Qual alternativa te√≥rica poderia explicar diferente?`,
        "Sem posicionamento te√≥rico.",
        "Lente te√≥rica expl√≠cita + implica√ß√µes."
      )
    );
  }

  return bank;
}

function q(id, difficulty, tags, personaProfile, questionFn, followFn, commonError, goldenTip){
  return {
    id, difficulty, tags, personaProfile,
    ask: questionFn, follow: followFn,
    commonError, goldenTip
  };
}

/* ======================
   SELE√á√ÉO ALEAT√ìRIA INTELIGENTE
====================== */
function mixRatios(mix){
  if(mix==="easy") return {easy:.50, med:.35, hard:.15};
  if(mix==="hard") return {easy:.20, med:.35, hard:.45};
  if(mix==="random") return {easy:.34, med:.33, hard:.33}; // ser√° random de verdade depois
  return {easy:.30, med:.40, hard:.30};
}

function buildQuestions(ctx, anchors){
  const bank = makeQuestionBank(ctx, anchors);

  // se n√£o tem banca cadastrada, cria padr√£o
  if(!committee.length){
    committee = [
      {name:"Avaliador(a) 1", profiles:["method","stats"], roleTone:"t√©cnico"},
      {name:"Avaliador(a) 2", profiles:["theory","critical"], roleTone:"duro"},
      {name:"Avaliador(a) 3", profiles:["practical"], roleTone:"aplicado"},
    ];
    renderCommittee();
  }

  // quantas
  const n = clamp(Number(ctx.nQuestions)||24, 8, 60);

  // embaralhar banco e escolher por dificuldade com quotas
  const ratios = mixRatios(ctx.difficultyMix);
  let nEasy = Math.round(n*ratios.easy);
  let nMed  = Math.round(n*ratios.med);
  let nHard = n - nEasy - nMed;

  if(ctx.difficultyMix==="random"){
    // aleat√≥rio total: sorteia dificuldades
    nEasy = nMed = nHard = 0;
  }

  const byDiff = {
    easy: shuffle(bank.filter(x=>x.difficulty==="easy").slice()),
    med:  shuffle(bank.filter(x=>x.difficulty==="med").slice()),
    hard: shuffle(bank.filter(x=>x.difficulty==="hard").slice()),
  };

  const selected = [];

  function pickFrom(diff, count){
    for(let i=0;i<count;i++){
      if(byDiff[diff].length) selected.push(byDiff[diff].pop());
      else {
        // fallback: pega de qualquer
        const any = shuffle(bank.slice());
        selected.push(any.pop());
      }
    }
  }

  if(ctx.difficultyMix==="random"){
    const diffs=["easy","med","hard"];
    const shuffledBank = shuffle(bank.slice());
    while(selected.length < n && shuffledBank.length){
      selected.push(shuffledBank.pop());
    }
  } else {
    pickFrom("easy", nEasy);
    pickFrom("med", nMed);
    pickFrom("hard", nHard);
  }

  // embaralhar ordem final (mistura f√°cil/m√©dia/dif√≠cil)
  shuffle(selected);

  // atribuir ‚Äúavaliador‚Äù por perfil
  const questions = selected.map(item=>{
    const member = pickMemberForQuestion(item);
    return materializeQuestion(item, member, anchors);
  });

  return questions;
}

function pickMemberForQuestion(item){
  // tenta pegar algu√©m cujo perfil casa com a pergunta
  const desired = item.personaProfile;
  const candidates = committee.filter(m => (m.profiles||[]).includes(desired));
  if(candidates.length) return sample(candidates);

  // fallback: se pergunta √© stats, tenta algu√©m com stats
  if(item.tags.includes("stats")){
    const c2 = committee.filter(m => (m.profiles||[]).includes("stats"));
    if(c2.length) return sample(c2);
  }
  if(item.tags.includes("qual")){
    const c3 = committee.filter(m => (m.profiles||[]).includes("qual"));
    if(c3.length) return sample(c3);
  }
  if(item.tags.includes("method")){
    const c4 = committee.filter(m => (m.profiles||[]).includes("method"));
    if(c4.length) return sample(c4);
  }
  if(item.tags.includes("theory")){
    const c5 = committee.filter(m => (m.profiles||[]).includes("theory"));
    if(c5.length) return sample(c5);
  }
  if(item.tags.includes("practical")){
    const c6 = committee.filter(m => (m.profiles||[]).includes("practical"));
    if(c6.length) return sample(c6);
  }

  // sen√£o, qualquer
  return sample(committee);
}

function materializeQuestion(item, member, anchors){
  const text = item.ask(member);
  const follow = item.follow(member);

  // pega uma ‚Äú√¢ncora‚Äù boa para exibir (se tiver)
  const anchor = sample(anchors)?.snippet || "";
  return {
    id: item.id,
    difficulty: item.difficulty,
    tags: item.tags,
    member,
    text,
    follow,
    commonError: item.commonError,
    goldenTip: item.goldenTip,
    anchor
  };
}

/* ======================
   SCORING (n√£o por palavras)
   Heur√≠stica por crit√©rios
====================== */
function evaluateAnswer(q, ans, ctx){
  const a = (ans||"").trim();
  const low = a.toLowerCase();

  // crit√©rios (0-10)
  let clarity = 6.0;
  let evidence = 6.0;
  let method = 6.0;
  let limits = 6.0;
  let coherence = 6.0;
  let confidence = 6.0;

  // penaliza enrola√ß√£o e muletas
  const hedging = /(acho|talvez|tipo|meio que|sei l√°|n√£o lembro|creio|imagino|n√©\?)/i.test(a);
  if(hedging){ clarity -= 1.0; confidence -= 1.3; }

  // estrutura m√≠nima: ponto + porque/portanto + limite
  const hasPoint = a.length >= 30;
  const hasBecause = /(porque|pois|portanto|logo|assim)/i.test(a);
  const hasLimit = /(limita|vi(e|√©)s|restri|incertez|n√£o foi poss√≠vel|escopo|generaliza)/i.test(a);

  if(!hasPoint) clarity -= 2.0;
  if(hasBecause) clarity += 0.8;
  if(hasLimit) limits += 1.2;

  // evid√™ncia: n√∫meros, dados, termos de resultado
  const hasNumbers = /\b\d+(\.\d+)?\b/.test(a);
  const hasDataWords = /(dados|amostra|n\s*=\s*\d+|entrevista|question(√°|a)rio|modelo|teste|an(√°|a)lise|observ|med|mensur)/i.test(a);
  const hasResultVerbs = /(mostr|indic|aument|reduz|associ|correl|efeito|signific)/i.test(a);

  if(hasNumbers) evidence += 1.1;
  if(hasDataWords) evidence += 0.9;
  if(hasResultVerbs) evidence += 0.7;

  // m√©todo: s√≥ cobra mais se pergunta tem tags method/stats/qual/review
  if(q.tags.includes("method") || q.tags.includes("stats") || q.tags.includes("qual") || q.tags.includes("review")){
    if(hasDataWords) method += 1.0;
    if(/supon|assun|normal|res(√≠|i)du|robust|sensibil|valida/i.test(a)) method += 1.0;
    if(a.length < 40) method -= 1.2;
  }

  // coer√™ncia: tenta ver se a resposta repete parte da √¢ncora/resumo
  // (bem simples: compartilha palavras-chave)
  if(q.anchor){
    const kw = keywords(q.anchor, 10);
    const hits = kw.filter(w => low.includes(w)).length;
    coherence += Math.min(1.4, hits * 0.18);
  }

  // confian√ßa vs agressividade da banca
  if(ctx.severity === "hard"){
    if(a.length > 380) clarity -= 0.8;  // enrola√ß√£o
    if(a.length < 45) confidence -= 0.8;
  } else {
    if(a.length < 35) confidence -= 0.6;
  }

  // clamp
  clarity = clamp(clarity,0,10);
  evidence = clamp(evidence,0,10);
  method = clamp(method,0,10);
  limits = clamp(limits,0,10);
  coherence = clamp(coherence,0,10);
  confidence = clamp(confidence,0,10);

  // pesos dependem do tipo de pergunta
  let w = {clarity:.22,evidence:.20,method:.20,limits:.14,coherence:.14,confidence:.10};
  if(q.tags.includes("stats")) w = {clarity:.18,evidence:.22,method:.26,limits:.14,coherence:.10,confidence:.10};
  if(q.tags.includes("qual"))  w = {clarity:.20,evidence:.18,method:.22,limits:.16,coherence:.14,confidence:.10};
  if(q.tags.includes("core"))  w = {clarity:.30,evidence:.14,method:.14,limits:.12,coherence:.18,confidence:.12};

  const final = clarity*w.clarity + evidence*w.evidence + method*w.method + limits*w.limits + coherence*w.coherence + confidence*w.confidence;

  // feedback
  const issues = [];
  const tips = [];

  if(!hasBecause) issues.push("Voc√™ n√£o justificou. Em banca, afirma√ß√£o sem 'por qu√™' vira alvo.");
  if(!hasLimit && (q.tags.includes("stats")||q.tags.includes("method")||q.tags.includes("results")||q.tags.includes("core"))) issues.push("Faltou limita√ß√£o/escopo. Banca chata cobra maturidade.");
  if(!hasDataWords && (q.tags.includes("method")||q.tags.includes("stats"))) issues.push("Voc√™ falou de m√©todo sem mostrar como operacionalizou (dados, instrumentos, crit√©rios).");
  if(hedging) issues.push("Voc√™ usou muletas ('acho', 'talvez', 'tipo'). Corte isso. Parece inseguran√ßa.");
  if(final < 6.5) tips.push("Estrutura vencedora: **ponto** ‚Üí **evid√™ncia** ‚Üí **limite** ‚Üí **implica√ß√£o**.");
  if(!hasNumbers && (q.tags.includes("stats")||q.tags.includes("method"))) tips.push("Se puder, cite um n√∫mero (n, per√≠odo, efeito, crit√©rio). Banca respeita concretude.");
  if(coherence < 6.2) tips.push("Ancore sua resposta no seu resumo: repita palavras-chave do objetivo/m√©todo/resultado.");

  // ‚Äúmood‚Äù
  const mood =
    final >= 8.3 ? "üî• banca impressionada" :
    final >= 7.0 ? "üòÑ banca ok" :
    final >= 6.0 ? "üòê banca desconfiada" :
                   "üò¨ banca afiando a faca";

  return { dims:{clarity,evidence,method,limits,coherence,confidence}, final, issues, tips, mood };
}

function keywords(text, max=10){
  const stop = new Set(["de","da","do","das","dos","a","o","e","em","para","por","com","que","uma","um","no","na","nos","nas","the","of","and","to","in","for","on","with","is","are"]);
  const tokens = (text||"").toLowerCase().replace(/[^\p{L}\p{N}\s]/gu," ").split(/\s+/).filter(Boolean);
  const freq = {};
  for(const t of tokens){
    if(t.length < 4) continue;
    if(stop.has(t)) continue;
    freq[t]=(freq[t]||0)+1;
  }
  return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,max).map(x=>x[0]);
}

/* ======================
   GRADE + REPORT
====================== */
function computeGrade(session){
  const arr = session.answers.map(x=>x.score?.final).filter(v=>typeof v==="number");
  const avg = arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;

  // leve penalidade por muitos ‚Äún√£o sei‚Äù
  const idk = session.answers.filter(x=>x.isIDK).length;
  let final = avg - idk*0.15;

  // pesos por n√≠vel (ajuste leve)
  if(session.ctx.level==="phd") final -= 0.2;

  final = clamp(final,0,10);
  const status =
    final >= 8.3 ? "PASSA COM LOUVOR" :
    final >= 7.0 ? "PASSA BEM" :
    final >= 6.0 ? "PASSA NO SUFOCO" :
                   "RISCO (TREINAR MAIS)";

  return { final, status };
}

function topIssues(session){
  const freq = {};
  for(const a of session.answers){
    (a.score?.issues||[]).forEach(i=>freq[i]=(freq[i]||0)+1);
  }
  return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([txt,n])=>({txt,n}));
}

function byMemberSummary(session){
  const map = {};
  for(const a of session.answers){
    const name = a.q.member.name;
    map[name] = map[name] || {count:0, avg:0};
    map[name].count++;
    map[name].avg += a.score.final;
  }
  Object.values(map).forEach(x=>x.avg = x.count ? x.avg/x.count : 0);
  return map;
}

/* ======================
   SESSION
====================== */
let session = null;

function saveSession(){
  if(!session) return;
  localStorage.setItem(SESSION_KEY, JSON.stringify({session, committee, draft: readDraft()}));
}
function loadSession(){
  const raw = localStorage.getItem(SESSION_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); } catch(e){ return null; }
}
function resetAll(){
  localStorage.removeItem(SESSION_KEY);
  session=null;
  committee=[];
  renderCommittee();
  renderIdle();
  toast("Resetado", "Tudo limpo. Cole o resumo e crie sua banca.");
}

/* ======================
   DRAFT (para n√£o perder config)
====================== */
function readDraft(){
  return {
    studentName: $("studentName").value,
    level: $("level").value,
    area: $("area").value,
    studyType: $("studyType").value,
    severity: $("severity").value,
    abstractText: $("abstractText").value,
    nQuestions: $("nQuestions").value,
    difficultyMix: $("difficultyMix").value,
  };
}
function applyDraft(d){
  if(!d) return;
  $("studentName").value = d.studentName || "";
  $("level").value = d.level || "tcc";
  $("area").value = d.area || "bio";
  $("studyType").value = d.studyType || "quant";
  $("severity").value = d.severity || "hard";
  $("abstractText").value = d.abstractText || "";
  $("nQuestions").value = d.nQuestions || 24;
  $("difficultyMix").value = d.difficultyMix || "balanced";
}
function saveDraft(){
  const raw = localStorage.getItem(SESSION_KEY);
  const existing = raw ? JSON.parse(raw) : {};
  localStorage.setItem(SESSION_KEY, JSON.stringify({...(existing||{}), draft: readDraft(), committee}));
}

/* ======================
   RENDER
====================== */
function setModePill(){
  const lvl = {tcc:"TCC",msc:"Mestrado",phd:"Doutorado"}[$("level").value];
  const sev = {calm:"Tranquila",tech:"T√©cnica",hard:"Chata"}[$("severity").value];
  const st  = {quant:"Quant",qual:"Quali",mixed:"Misto",theory:"Te√≥rico",applied:"Aplicado",review:"Revis√£o"}[$("studyType").value];
  $("modePill").textContent = `${lvl} ‚Ä¢ ${st} ‚Ä¢ ${sev}`;
}

function renderIdle(){
  setModePill();
  $("kpiAnchor").textContent = "‚Äî";
  $("kpiPDF").textContent = "‚Äî";
  $("kpiQ").textContent = "‚Äî";
  $("kpiConf").textContent = "‚Äî";
  $("digest").textContent = "";
  $("whoName").textContent = "Professor(a) da banca";
  $("whoRole").textContent = "‚Äî";
  $("qText").innerHTML = `Cole o resumo e clique em <b>Analisar e come√ßar</b> (ou carregue o DEMO).`;
  $("qTags").innerHTML = "";
  $("fbBox").classList.add("hide");
  $("answer").value = "";
  $("done").textContent = "0";
  $("total").textContent = "0";
  $("liveGrade").textContent = "‚Äî";
  $("mood").textContent = "‚Äî";
  $("progFill").style.width = "0%";
}

function renderQuestion(){
  setModePill();
  const q = session.questions[session.qi];
  if(!q){
    $("qText").textContent = "Fim das perguntas. Gere o relat√≥rio final.";
    $("qTags").innerHTML = "";
    return;
  }

  $("whoName").textContent = q.member.name;
  const tone = q.member.roleTone || "t√©cnico";
  $("whoRole").textContent = `${tone} ‚Ä¢ ${q.member.profiles.map(profileLabel).join(", ")}`;

  // pergunta + √¢ncora curta
  const anchor = q.anchor ? `\n\nüéØ Trecho gatilho: ‚Äú${q.anchor}‚Äù` : "";
  $("qText").textContent = `${q.text}${anchor}`;

  $("qTags").innerHTML = `
    <span class="tag">${q.difficulty.toUpperCase()}</span>
    ${q.tags.map(t=>`<span class="tag">${t}</span>`).join("")}
  `;

  $("answer").value="";
  $("fbBox").classList.add("hide");

  const done = session.answers.length;
  const total = session.questions.length;
  $("done").textContent = String(done);
  $("total").textContent = String(total);
  $("progFill").style.width = total ? pct(done/total) : "0%";

  const g = computeGrade(session);
  $("liveGrade").textContent = done ? g.final.toFixed(1) : "‚Äî";
  $("mood").textContent = done ? (session.answers.at(-1)?.score?.mood || "‚Äî") : "‚Äî";
}

function renderFeedback(score, q){
  $("fbBox").classList.remove("hide");

  const mood =
    score.final >= 8.3 ? {title:"üî• Excelente. Isso √© resposta de quem domina.", color:"var(--g)"} :
    score.final >= 7.0 ? {title:"üòÑ Boa. D√° pra passar com seguran√ßa.", color:"var(--g)"} :
    score.final >= 6.0 ? {title:"üòê Ok‚Ä¶ mas tem vulnerabilidade.", color:"var(--y)"} :
                         {title:"üò¨ Perigoso. Isso sangra nota em banca chata.", color:"var(--r2)"};

  $("fbTitle").textContent = mood.title;
  $("fbTitle").style.color = mood.color;

  const d = score.dims;
  $("fbSummary").innerHTML =
    `<b>Nota desta resposta:</b> ${score.final.toFixed(1)} / 10 ‚Ä¢ ` +
    `Clareza ${d.clarity.toFixed(1)} | Evid√™ncia ${d.evidence.toFixed(1)} | M√©todo ${d.method.toFixed(1)} | Limites ${d.limits.toFixed(1)} | Coer√™ncia ${d.coherence.toFixed(1)} | Seguran√ßa ${d.confidence.toFixed(1)} ` +
    `<br><span class="small"><b>Erro comum:</b> ${q.commonError} ‚Ä¢ <b>Dica de ouro:</b> ${q.goldenTip}</span>`;

  const items = [];
  (score.issues||[]).forEach(x=>items.push(`‚ùå ${x}`));
  (score.tips||[]).forEach(x=>items.push(`üîß ${x}`));
  if(!items.length) items.push("‚úÖ Resposta consistente. Agora mantenha isso sem se contradizer nas pr√≥ximas perguntas.");

  $("fbList").innerHTML = items.map(x=>`<li>${escapeHtml(x)}</li>`).join("");
  $("followQ").textContent = q.follow;
}

/* ======================
   BUILD SESSION
====================== */
async function start(){
  const abstract = $("abstractText").value.trim();
  if(wordsCount(abstract) < 35){
    toast("Resumo fraco", "Cole um resumo com pelo menos ~35 palavras. √â dele que saem perguntas espec√≠ficas.");
    return;
  }

  const ctx = {
    studentName: $("studentName").value.trim(),
    level: $("level").value,
    area: $("area").value,
    studyType: $("studyType").value,
    severity: $("severity").value,
    nQuestions: $("nQuestions").value,
    difficultyMix: $("difficultyMix").value,
  };

  const anchors = extractAnchors(abstract);
  $("kpiAnchor").textContent = String(anchors.length);

  // PDF opcional
  let pdfInfo = { ok:false, words:0, pages:0 };
  const file = $("pdfInput").files?.[0];
  if(file){
    try{
      toast("PDF (opcional)", "Tentando extrair texto do PDF‚Ä¶");
      const ex = await extractPdfText(file);
      const w = wordsCount(ex.text);
      pdfInfo = { ok:true, words:w, pages:ex.pages };
      $("kpiPDF").textContent = w ? `${w} palavras` : "0 (prov√°vel escaneado)";
    } catch(e){
      console.warn(e);
      $("kpiPDF").textContent = "falhou";
    }
  } else {
    $("kpiPDF").textContent = "‚Äî";
  }

  // diagn√≥stico simples
  const conf =
    anchors.length >= 6 ? "ALTA" :
    anchors.length >= 3 ? "M√âDIA" : "BAIXA";
  $("kpiConf").textContent = conf;

  // gerar perguntas
  const questions = buildQuestions(ctx, anchors);
  $("kpiQ").textContent = String(questions.length);

  session = {
    version:2,
    createdAt: nowISO(),
    ctx,
    abstract,
    anchors,
    pdfInfo,
    questions,
    qi:0,
    answers:[]
  };

  $("digest").innerHTML =
    `<b>Diagn√≥stico:</b> ${conf}. ` +
    `Perguntas s√£o geradas do seu resumo (√¢ncoras + frases-chave). ` +
    `Se o PDF for escaneado, tudo bem ‚Äî o resumo resolve.`;

  saveSession();
  renderQuestion();
  toast("Vamos!", "Come√ßou. Responda como se estivesse na banca. Objetivo + evid√™ncia + limite.");
}

function next(){
  session.qi++;
  if(session.qi >= session.questions.length){
    toast("Fim", "Acabaram as perguntas. Gere o relat√≥rio final.");
    session.qi = session.questions.length;
    saveSession();
    renderQuestion();
    return;
  }
  saveSession();
  renderQuestion();
}

function answerFlow(isIDK=false){
  if(!session){
    toast("Sem sess√£o", "Clique em Analisar e come√ßar (ou carregue DEMO).");
    return;
  }
  const q = session.questions[session.qi];
  if(!q){
    toast("Fim", "Gere o relat√≥rio final.");
    return;
  }

  let ans = $("answer").value.trim();
  if(isIDK){
    ans =
`Eu n√£o tenho esse detalhe de mem√≥ria agora, mas consigo responder com transpar√™ncia:
(1) O que eu consigo afirmar com seguran√ßa √©: ______.
(2) O que eu precisaria consultar/rodar para responder exatamente √©: ______.
(3) Isso n√£o invalida o trabalho porque: ______.
(4) Como continuidade, eu faria: ______.`;
    $("answer").value = ans;
  }
  ans = $("answer").value.trim();
  if(!ans){
    toast("Cad√™ a resposta?", "Em banca, sil√™ncio n√£o pontua. Responda objetivamente.");
    return;
  }

  const score = evaluateAnswer(q, ans, session.ctx);
  session.answers.push({ q, answer: ans, score, isIDK, at: nowISO() });

  // confetti / feedback emocional
  if(score.final >= 8.3){
    confetti.burst(160, 1300);
    toast("üî• BOA!", "Isso √© resposta de quem domina. Mant√©m esse padr√£o.");
  } else if(score.final >= 7.0){
    confetti.burst(90, 900);
    toast("üòÑ Ok!", "Voc√™ est√° no caminho. S√≥ deixa mais concreto quando puder.");
  } else if(score.final >= 6.0){
    toast("üòê Aten√ß√£o", "D√° pra passar, mas banca chata vai apertar. Use evid√™ncia + limite.");
  } else {
    toast("üò¨ Calma", "N√£o √© fracasso. √â treino. Vamos ajustar e subir sua nota.");
  }

  // atualizar UI
  saveSession();
  renderFeedback(score, q);

  const done = session.answers.length;
  const total = session.questions.length;
  $("done").textContent = String(done);
  $("total").textContent = String(total);
  $("progFill").style.width = total ? pct(done/total) : "0%";

  const g = computeGrade(session);
  $("liveGrade").textContent = g.final.toFixed(1);
  $("mood").textContent = score.mood;
}

async function finish(){
  if(!session){
    toast("Sem sess√£o", "Inicie uma simula√ß√£o primeiro.");
    return;
  }
  if(session.answers.length < 5){
    toast("Pouco treino", "Responda pelo menos 5 perguntas para o relat√≥rio ficar confi√°vel.");
    return;
  }
  await generateReportPDF(session);
}

async function generateReportPDF(session){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  const name = (session.ctx.studentName || "Aluno(a)").trim();
  const lvl = {tcc:"TCC",msc:"Mestrado",phd:"Doutorado"}[session.ctx.level];
  const area = {bio:"Biol√≥gicas/Ambientais",exa:"Exatas/Tecnologia",hum:"Humanas/Sociais",int:"Interdisciplinar"}[session.ctx.area];
  const st = {quant:"Quantitativo",qual:"Qualitativo",mixed:"Misto",theory:"Te√≥rico",applied:"Aplicado",review:"Revis√£o"}[session.ctx.studyType];
  const sev = {calm:"Tranquila",tech:"T√©cnica",hard:"Chata"}[session.ctx.severity];

  const grade = computeGrade(session);
  const issues = topIssues(session);
  const byM = byMemberSummary(session);

  // perguntas ‚Äúmais prov√°veis‚Äù: as que voc√™ foi pior + 6 aleat√≥rias do banco
  const sorted = session.answers.slice().sort((a,b)=>a.score.final-b.score.final);
  const worst = sorted.slice(0,6).map(x=>x.q);
  const extra = shuffle(session.questions.slice()).slice(0,6);
  const likely = [];
  const seen = new Set();
  [...worst, ...extra].forEach(q=>{
    if(seen.has(q.id)) return;
    seen.add(q.id);
    likely.push(q);
  });

  let y=54;

  doc.setFont("helvetica","bold"); doc.setFontSize(18);
  doc.text("GURU DE BANCA ‚Äî Relat√≥rio Final", 40, y); y+=18;

  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text(`Gerado em: ${nowISO()}`, 40, y); y+=14;
  doc.text(`Aluno(a): ${name}`, 40, y); y+=14;
  doc.text(`N√≠vel: ${lvl} ‚Ä¢ √Årea: ${area} ‚Ä¢ Tipo: ${st} ‚Ä¢ Banca: ${sev}`, 40, y); y+=18;

  doc.setFont("helvetica","bold");
  doc.text("Nota estimada", 40, y); y+=14;
  doc.setFont("helvetica","normal");
  doc.text(`Nota final estimada: ${grade.final.toFixed(1)} / 10`, 40, y); y+=14;
  doc.text(`Status: ${grade.status}`, 40, y); y+=18;

  doc.setFont("helvetica","bold");
  doc.text("Resumo utilizado (base das perguntas)", 40, y); y+=14;
  doc.setFont("helvetica","normal");
  doc.text(session.abstract.slice(0,900) + (session.abstract.length>900?"‚Ä¶":""), 40, y, {maxWidth:520});
  y+= 140;

  doc.setFont("helvetica","bold");
  doc.text("Riscos cr√≠ticos (o que pode derrubar nota)", 40, y); y+=14;
  doc.setFont("helvetica","normal");
  if(!issues.length){
    doc.text("Sem padr√µes de fragilidade detectados (ou respostas muito consistentes).", 40, y); y+=14;
  } else {
    issues.forEach(r=>{
      doc.text(`‚Ä¢ (${r.n}x) ${r.txt}`, 40, y, {maxWidth:520});
      y+=14;
      if(y>760){ doc.addPage(); y=54; }
    });
  }
  y+=10;

  doc.setFont("helvetica","bold");
  doc.text("Desempenho por avaliador (para voc√™ treinar em cima de pessoas reais)", 40, y); y+=14;
  doc.setFont("helvetica","normal");
  Object.entries(byM).forEach(([k,v])=>{
    doc.text(`‚Ä¢ ${k}: m√©dia ${v.avg.toFixed(1)} em ${v.count} perguntas`, 40, y);
    y+=14;
    if(y>760){ doc.addPage(); y=54; }
  });
  y+=10;

  doc.setFont("helvetica","bold");
  doc.text("Perguntas mais prov√°veis na banca (treine MUITO)", 40, y); y+=14;
  doc.setFont("helvetica","normal");
  likely.slice(0,10).forEach((q,i)=>{
    doc.text(`${i+1}. (${q.member.name}) ${q.text}`, 40, y, {maxWidth:520});
    y+=22;
    if(y>760){ doc.addPage(); y=54; }
  });
  y+=10;

  doc.setFont("helvetica","bold");
  doc.text("Frases de sobreviv√™ncia (use sem vergonha)", 40, y); y+=14;
  doc.setFont("helvetica","normal");
  const escapes = [
    "‚Ä¢ ‚ÄúExcelente pergunta. Esse ponto foge do escopo do estudo, mas abre uma continuidade objetiva: ______.‚Äù",
    "‚Ä¢ ‚ÄúCom o desenho atual eu falo em associa√ß√£o; para causalidade eu precisaria de ______.‚Äù",
    "‚Ä¢ ‚ÄúA limita√ß√£o principal √© ______. Eu mitiguei com ______, ent√£o a conclus√£o deve ser lida como ______.‚Äù",
    "‚Ä¢ ‚ÄúUma explica√ß√£o alternativa √© ______. Eu favore√ßo minha interpreta√ß√£o porque ______.‚Äù",
  ];
  escapes.forEach(line=>{
    doc.text(line, 40, y, {maxWidth:520}); y+=16;
    if(y>760){ doc.addPage(); y=54; }
  });

  doc.save(`guru-de-banca_v2_${name.replace(/\s+/g,"_")}.pdf`);

  // celebra√ß√£o final conforme nota
  if(grade.final >= 7.0){
    confetti.burst(220, 1600);
    toast("üéâ DEFESA COM CARA DE FESTA!", `Relat√≥rio baixado. Nota estimada ${grade.final.toFixed(1)} ‚Äî voc√™ vai bem.`);
  } else {
    toast("üí™ Voc√™ vai virar o jogo", `Relat√≥rio baixado. Nota estimada ${grade.final.toFixed(1)} ‚Äî treine os riscos cr√≠ticos e refa√ßa o simulado.`);
  }
}

/* ======================
   HINTS
====================== */
function hintFor(q, ctx){
  if(q.tags.includes("core")) return "Responda em 2 frases: **problema** + **por que importa**. Sem contexto longo.";
  if(q.tags.includes("stats")) return "Mostre que voc√™ domina: **suponi√ß√µes** + **como checa** + **limite** + **confus√£o**.";
  if(q.tags.includes("qual")) return "Use rigor: **satura√ß√£o/triangula√ß√£o/rastreabilidade/reflexividade** + limite.";
  if(q.tags.includes("method")) return "**delineamento** + **amostra/instrumento** + **vi√©s** + **mitiga√ß√£o**.";
  if(q.tags.includes("practical")) return "**recomenda√ß√£o condicional** + **onde aplica** + **onde n√£o aplica**.";
  return "Ponto central ‚Üí evid√™ncia ‚Üí limite ‚Üí implica√ß√£o.";
}

/* ======================
   DEMO real
====================== */
function loadDemo(){
  $("studentName").value = "Ernandes";
  $("level").value = "msc";
  $("area").value = "bio";
  $("studyType").value = "mixed";
  $("severity").value = "hard";
  $("nQuestions").value = 24;
  $("difficultyMix").value = "balanced";

  $("abstractText").value =
`Objetivo: avaliar como a varia√ß√£o sazonal de temperatura e precipita√ß√£o influencia a ocorr√™ncia de focos de calor em munic√≠pios do Pantanal. 
M√©todos: estudo observacional com dados mensais (2003‚Äì2024) agregados por munic√≠pio, combinando s√©ries clim√°ticas e focos de calor, com an√°lise de associa√ß√£o e defasagem temporal. 
Resultados: observou-se aumento de focos no mesmo ano de menor precipita√ß√£o, com maior sensibilidade entre julho e novembro, e diferen√ßas entre plan√≠cie e planalto. 
Conclus√£o: os resultados sugerem que a seca sazonal e extremos clim√°ticos amplificam o risco de inc√™ndios, apoiando estrat√©gias de preven√ß√£o e monitoramento direcionadas. 
Limita√ß√µes: poss√≠veis vieses por subdetec√ß√£o de focos e heterogeneidade espacial.`;

  committee = [
    {name:"Profa. Maria (Teoria)", profiles:["theory","critical"], roleTone:"duro"},
    {name:"Prof. Jo√£o (Estat√≠stica)", profiles:["stats","method"], roleTone:"t√©cnico"},
    {name:"Profa. Ana (Qualitativo/Cr√≠tica)", profiles:["qual","critical"], roleTone:"duro"},
    {name:"Prof. Carlos (Pol√≠ticas P√∫blicas)", profiles:["practical"], roleTone:"aplicado"},
  ];
  renderCommittee();
  saveDraft();
  renderIdle();
  toast("DEMO carregado", "Agora clique em 'Analisar e come√ßar simula√ß√£o'.");
}

/* ======================
   RESUME
====================== */
function resume(){
  const loaded = loadSession();
  if(!loaded || !loaded.session){
    toast("Nada salvo", "N√£o encontrei sess√£o salva.");
    return;
  }
  committee = loaded.committee || [];
  session = loaded.session;

  if(loaded.draft) applyDraft(loaded.draft);
  renderCommittee();

  $("kpiAnchor").textContent = String(session.anchors?.length || 0);
  $("kpiPDF").textContent = session.pdfInfo?.ok ? `${session.pdfInfo.words} palavras` : "‚Äî";
  $("kpiQ").textContent = String(session.questions?.length || 0);
  $("kpiConf").textContent =
    (session.anchors?.length || 0) >= 6 ? "ALTA" :
    (session.anchors?.length || 0) >= 3 ? "M√âDIA" : "BAIXA";

  $("digest").innerHTML = `<b>Sess√£o retomada:</b> ${session.createdAt}. Continue a simula√ß√£o.`;
  renderQuestion();
  toast("Retomado", "Sess√£o carregada. Continue respondendo.");
}

/* ======================
   HTML escape
====================== */
function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}

/* ======================
   EVENTS
====================== */
$("btnAddMember").addEventListener("click", ()=>{
  addMember($("memberName").value, $("memberPrimary").value);
});
$("btnAdd3Default").addEventListener("click", ()=>{
  committee = [
    {name:"Profa. (Metodologia)", profiles:["method"], roleTone:"t√©cnico"},
    {name:"Prof. (Teoria/Cr√≠tico)", profiles:["theory","critical"], roleTone:"duro"},
    {name:"Profa. (Estat√≠stica)", profiles:["stats"], roleTone:"t√©cnico"},
  ];
  renderCommittee();
  saveDraft();
  toast("Banca criada", "Edite perfis se quiser (bot√£o 'Editar perfis').");
});

$("btnStart").addEventListener("click", start);
$("btnDemo").addEventListener("click", loadDemo);
$("btnResume").addEventListener("click", resume);
$("btnReset").addEventListener("click", resetAll);

$("btnAnswer").addEventListener("click", ()=> answerFlow(false));
$("btnIDK").addEventListener("click", ()=> answerFlow(true));
$("btnHint").addEventListener("click", ()=>{
  if(!session){
    toast("Dica", "Cole o resumo, crie banca e comece. Depois eu dou dica por pergunta.");
    return;
  }
  const q = session.questions[session.qi];
  toast("Dica de banca", hintFor(q, session.ctx), 3200);
});

$("btnNext").addEventListener("click", next);
$("btnFinish").addEventListener("click", finish);

["studentName","level","area","studyType","severity","abstractText","nQuestions","difficultyMix"].forEach(id=>{
  $(id).addEventListener("input", ()=>{ setModePill(); saveDraft(); });
});
$("severity").addEventListener("change", ()=>{ setModePill(); saveDraft(); });

/* INIT */
const loaded = loadSession();
if(loaded?.draft) applyDraft(loaded.draft);
committee = loaded?.committee || committee;
renderCommittee();
renderIdle();
</script>

</body>
</html>
